# 快速开始指南

本指南将帮助您快速上手 BatchWeaver 框架，完成第一个文件导入任务。

## 前置条件

- Java 21+
- Maven 3.8+
- SQL Server 2022
- Spring Boot 3.5.7

## 5 分钟快速体验

### 步骤 1: 配置数据库

修改 `src/main/resources/application.yml`：

```yaml
spring:
  datasource:
    db1:
      jdbc-url: jdbc:sqlserver://localhost:1433;databaseName=BatchWeaverDB;encrypt=false;trustServerCertificate=true
      username: sa
      password: YourPassword123
    db2:
      jdbc-url: jdbc:sqlserver://localhost:1433;databaseName=DB2_Business;encrypt=false;trustServerCertificate=true
      username: sa
      password: YourPassword123
```

### 步骤 2: 创建数据库

```sql
CREATE DATABASE BatchWeaverDB;
CREATE DATABASE DB2_Business;
```

### 步骤 3: 准备测试文件

创建 `data/input/users.txt`：

```
20260120
张三,25,zhangsan@example.com,1990-01-15
李四,30,lisi@example.com,1985-06-20
王五,28,wangwu@example.com,1987-03-10
3
```

### 步骤 4: 运行应用

```bash
mvn clean install
mvn spring-boot:run
```

### 步骤 5: 运行 Job 测试

**使用脚本运行 Job**:

**Windows (PowerShell)**:
```powershell
# 运行所有 Job
.\script\run-all-jobs-maven.ps1
```

**Linux/Mac (Bash)**:
```bash
# 运行所有 Job
./script/run-all-jobs.sh

# 运行单个 Job
./script/run-job.sh demoJob
```

**使用 Maven 直接运行**:
```bash
# 运行单个 Job
mvn spring-boot:run -Dspring-boot.run.arguments=--job.name=demoJob
```

### 步骤 6: 验证结果

检查控制台输出：
- ✅ "Header parsed: ..."
- ✅ "Footer validation passed: expected=3, actual=3"
- ✅ 数据已成功导入 `DB2_Business` 数据库
- ✅ "Job: [SimpleJob: [name=demoJob]] completed with status: [COMPLETED]"

---

## 使用 HeaderFooterAwareReader（推荐）

### 基本用法

```java
@Configuration
public class ImportJobConfig {

    @Bean
    public Job importJob(JobRepository jobRepository,
                         @Qualifier("tm2") PlatformTransactionManager tm2) {

        FileSystemResource resource = new FileSystemResource("data/input/users.txt");

        // 1. 创建延迟决策 Reader
        HeaderFooterAwareReader<User> reader = template.createDeferredDecisionReader(
            resource,
            line -> new HeaderInfo(LocalDate.parse(line, DateTimeFormatter.ofPattern("yyyyMMdd"))), // Header 解析
            header -> { if (!header.getDate().equals(LocalDate.now())) throw new IllegalStateException("日期不匹配"); }, // Header 校验
            line -> new FooterInfo(Long.parseLong(line.trim())), // Footer 解析
            (footer, actual) -> { if (footer.getCount() != actual) throw new IllegalStateException("数量不匹配"); }, // Footer 校验
            new DelimitedLineTokenizer(),
            new AnnotationDrivenFieldSetMapper<>(User.class)
        );

        // 2. 配置 Processor 和 Writer
        ItemProcessor<User, User> processor = new DataCleansingProcessor<>();
        ItemWriter<User> writer = items -> userService.batchInsert(items.getItems());

        // 3. 构建 Job
        FileImportJobTemplate.FileImportJobDefinition<User, User> definition =
            FileImportJobTemplate.FileImportJobDefinition.<User, User>builder()
                .jobName("importJob")
                .stepName("importStep")
                .jobRepository(jobRepository)
                .transactionManager(tm2)
                .reader(reader)
                .processor(processor)
                .writer(writer)
                .skipLimit(100)   // 跳过最多 100 条错误记录
                .retryLimit(3)    // 重试最多 3 次
                .build();

        return template.buildJob(definition);
    }
}
```

### 文件格式说明

#### 格式 1: 带日期 Header + 纯数字 Footer

```
20260120
张三,25,zhangsan@example.com,1990-01-15
李四,30,lisi@example.com,1985-06-20
3
```

#### 格式 2: 带日期 Header + R 前缀 Footer

```
01202026
张三,25,zhangsan@example.com,1990-01-15
李四,30,lisi@example.com,1985-06-20
R00003
```

#### 格式 3: 无头尾

```
张三,25,zhangsan@example.com,1990-01-15
李四,30,lisi@example.com,1985-06-20
王五,28,wangwu@example.com,1987-03-10
```

---

## 实体类定义

```java
@Data
public class User {
    @FileColumn(index = 0, name = "userId")
    private Integer id;

    @FileColumn(index = 1, trim = true)
    private String name;

    @FileColumn(index = 2, trim = true)
    private String email;

    @FileColumn(index = 3, pattern = "yyyy-MM-dd")
    private Date birthDate;
}
```

---

## 常见问题

### Q: 如何处理超大文件（GB 级）？

A: 使用 `HeaderFooterAwareReader`，它采用单次扫描 + 延迟决策模式：
- 零启动延迟
- O(1) 内存占用
- 适合超大文件处理

### Q: 如何自定义 Footer 检测规则？

A: 实现自定义 `FooterLineDetector`：

```java
FooterLineDetector customDetector = line -> {
    if (line.startsWith("T|")) return true;
    if (line.startsWith("COUNT:")) return true;
    return false;
};
```

### Q: 如何启用 skip/retry 机制？

A: 在 `FileImportJobDefinition` 中配置：

```java
.skipLimit(100)   // 最多跳过 100 条错误记录
.retryLimit(3)    // 每条记录最多重试 3 次
```

### Q: 如何处理不同格式的文件？

A: 实现自定义的 `HeaderParser` 和 `FooterParser`：

```java
HeaderParser customHeaderParser = line -> {
    // 自定义解析逻辑
    String[] parts = line.split("\\|");
    return new HeaderInfo(parts[0], parts[1]);
};

FooterParser customFooterParser = line -> {
    // 自定义解析逻辑
    String[] parts = line.split("\\|");
    return new FooterInfo(Long.parseLong(parts[1]));
};
```

---

## 下一步

- 查看 [docs/文件读写.md](文件读写.md) 了解架构设计
- 查看 [docs/技术框架.md](技术框架.md) 了解核心组件
- 查看 [docs/多数据源.md](多数据源.md) 了解事务隔离配置
- 查看 [docs/测试文档.md](测试文档.md) 了解更多测试示例
- 运行测试验证事务隔离：`mvn test -Dtest=TransactionIsolationTest`
