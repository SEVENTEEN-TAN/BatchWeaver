# å¤šæ•°æ®æºé…ç½®ä¸äº‹åŠ¡éš”ç¦»æ–‡æ¡£

## æ–‡æ¡£ä¿¡æ¯

| é¡¹ç›® | å†…å®¹ |
|------|------|
| **é…ç½®ç‰ˆæœ¬** | 1.0.0 |
| **æ–‡æ¡£æ—¥æœŸ** | 2026-01-20 |
| **é€‚ç”¨åœºæ™¯** | å¤šæ•°æ®åº“ã€åˆ†å¸ƒå¼æ‰¹å¤„ç† |

---

## 1. å¤šæ•°æ®æºæ¶æ„æ¦‚è¿°

### 1.1 æ•°æ®æºè§„åˆ’

| æ•°æ®æº | ç”¨é€” | æ•°æ®åº“ | äº‹åŠ¡ç®¡ç†å™¨ |
|--------|------|--------|-----------|
| **db1** | Spring Batch å…ƒæ•°æ® + ä¸šåŠ¡æ•°æ® | BatchWeaverDB | tm1 |
| **db2** | ä¸šåŠ¡æ•°æ®åº“ 2 | DB2_Business | tm2 |
| **db3** | ä¸šåŠ¡æ•°æ®åº“ 3 | DB3_Business | tm3 |
| **db4** | ä¸šåŠ¡æ•°æ®åº“ 4 | DB4_Business | tm4 |

### 1.2 äº‹åŠ¡éš”ç¦»åŸåˆ™

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    äº‹åŠ¡éš”ç¦»è®¾è®¡é“å¾‹                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  ğŸ”´ å…ƒæ•°æ®äº‹åŠ¡ï¼ˆtm1ï¼‰ï¼š                                              â”‚
â”‚     â””â”€â”€ ç»å¯¹ä¸å—ä¸šåŠ¡äº‹åŠ¡å½±å“ï¼Œå¿…é¡»æäº¤æˆåŠŸï¼                         â”‚
â”‚         â”œâ”€â”€ ç®¡ç† Batch æ¡†æ¶å…ƒæ•°æ®è¡¨                                 â”‚
â”‚         â”œâ”€â”€ å³ä½¿ Step æ‰§è¡Œå¤±è´¥ï¼Œå…ƒæ•°æ®ä¹Ÿå¿…é¡»è®°å½• FAILED çŠ¶æ€        â”‚
â”‚         â””â”€â”€ ç¡®ä¿æ–­ç‚¹ç»­ä¼ ã€å¤±è´¥é‡è¯•æœºåˆ¶çš„å¯é æ€§                       â”‚
â”‚                                                                     â”‚
â”‚  âœ… ä¸šåŠ¡äº‹åŠ¡ï¼ˆtm2/tm3/tm4ï¼‰ï¼š                                        â”‚
â”‚     â””â”€â”€ ç®¡ç†ä¸šåŠ¡æ•°æ®æ“ä½œï¼Œå¤±è´¥æ—¶å¯ä»¥å›æ»š                            â”‚
â”‚         â”œâ”€â”€ æ¯ä¸ª Step æ˜¾å¼æŒ‡å®šä¸šåŠ¡äº‹åŠ¡ç®¡ç†å™¨                        â”‚
â”‚         â”œâ”€â”€ å¤±è´¥æ—¶ä¸šåŠ¡æ•°æ®ä¸ä¼šè¢«æŒä¹…åŒ–                              â”‚
â”‚         â””â”€â”€ ä¿è¯æ•°æ®ä¸€è‡´æ€§å’Œå®Œæ•´æ€§                                  â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 å¤±è´¥åœºæ™¯æµç¨‹

```
Step æ‰§è¡Œæµç¨‹ï¼š
â”œâ”€â”€ å¼€å§‹æ‰§è¡Œ Step
â”‚   â”œâ”€â”€ [tm1 äº‹åŠ¡] å…ƒæ•°æ®å†™å…¥ï¼šJOB_EXECUTION çŠ¶æ€ = STARTED
â”‚   â””â”€â”€ [tm2 äº‹åŠ¡] ä¸šåŠ¡æ•°æ®å†™å…¥ï¼šINSERT INTO db2.DEMO_USER ...
â”‚
â”œâ”€â”€ Step æ‰§è¡Œå¤±è´¥ï¼ˆå¦‚ï¼šæ•°æ®åº“çº¦æŸå†²çªï¼‰
â”‚   â”œâ”€â”€ âŒ [tm2 äº‹åŠ¡] ä¸šåŠ¡äº‹åŠ¡å›æ»š â†’ db2 æ•°æ®ä¸è½åº“
â”‚   â””â”€â”€ âœ… [tm1 äº‹åŠ¡] å…ƒæ•°æ®äº‹åŠ¡æäº¤ â†’ JOB_EXECUTION çŠ¶æ€ = FAILED
â”‚
â””â”€â”€ ç»“æœ
    â”œâ”€â”€ âœ… å…ƒæ•°æ®è¡¨è®°å½•äº†å¤±è´¥çŠ¶æ€ï¼ˆæ”¯æŒæ–­ç‚¹ç»­ä¼ ï¼‰
    â””â”€â”€ âœ… ä¸šåŠ¡æ•°æ®ä¿æŒä¸€è‡´æ€§ï¼ˆè„æ•°æ®å·²å›æ»šï¼‰
```

---

## 2. æ•°æ®æºé…ç½®è¯¦è§£

### 2.1 application.yml é…ç½®

```yaml
spring:
  datasource:
    # DB1: Spring Batch å…ƒæ•°æ® + ä¸šåŠ¡æ•°æ®ï¼ˆä¸»æ•°æ®æºï¼‰
    db1:
      jdbc-url: jdbc:sqlserver://localhost:1433;databaseName=BatchWeaverDB;encrypt=true;trustServerCertificate=true
      username: sa
      password: YourPassword123
      driver-class-name: com.microsoft.sqlserver.jdbc.SQLServerDriver
      hikari:
        maximum-pool-size: 15
        minimum-idle: 5
        connection-timeout: 10000
        idle-timeout: 600000
        max-lifetime: 1800000
        pool-name: HikariPool-DB1

    # DB2: ä¸šåŠ¡æ•°æ®åº“ 2
    db2:
      jdbc-url: jdbc:sqlserver://localhost:1433;databaseName=DB2_Business;encrypt=true;trustServerCertificate=true
      username: sa
      password: YourPassword123
      driver-class-name: com.microsoft.sqlserver.jdbc.SQLServerDriver
      hikari:
        maximum-pool-size: 10
        minimum-idle: 3
        connection-timeout: 10000
        pool-name: HikariPool-DB2

    # DB3: ä¸šåŠ¡æ•°æ®åº“ 3
    db3:
      jdbc-url: jdbc:sqlserver://localhost:1433;databaseName=DB3_Business;encrypt=true;trustServerCertificate=true
      username: sa
      password: YourPassword123
      driver-class-name: com.microsoft.sqlserver.jdbc.SQLServerDriver
      hikari:
        maximum-pool-size: 10
        minimum-idle: 3
        connection-timeout: 10000
        pool-name: HikariPool-DB3

    # DB4: ä¸šåŠ¡æ•°æ®åº“ 4
    db4:
      jdbc-url: jdbc:sqlserver://localhost:1433;databaseName=DB4_Business;encrypt=true;trustServerCertificate=true
      username: sa
      password: YourPassword123
      driver-class-name: com.microsoft.sqlserver.jdbc.SQLServerDriver
      hikari:
        maximum-pool-size: 10
        minimum-idle: 3
        connection-timeout: 10000
        pool-name: HikariPool-DB4

  # Spring Batch é…ç½®
  batch:
    jdbc:
      initialize-schema: always          # è‡ªåŠ¨åˆå§‹åŒ– Batch å…ƒæ•°æ®è¡¨
      table-prefix: BATCH_                # å…ƒæ•°æ®è¡¨å‰ç¼€ï¼ˆé»˜è®¤ï¼‰
    job:
      enabled: false                      # ç¦æ­¢å¯åŠ¨æ—¶è‡ªåŠ¨è¿è¡Œ Job
```

### 2.2 DataSource1Config.java

**èŒè´£**ï¼šé…ç½® db1 æ•°æ®æºã€JdbcTemplateã€äº‹åŠ¡ç®¡ç†å™¨

```java
@Configuration
public class DataSource1Config {

    @Primary
    @Bean(name = "dataSource1")
    @ConfigurationProperties(prefix = "spring.datasource.db1")
    public DataSource dataSource1() {
        return DataSourceBuilder.create().build();
    }

    @Primary
    @Bean(name = "jdbcTemplate1")
    public JdbcTemplate jdbcTemplate1(@Qualifier("dataSource1") DataSource dataSource) {
        return new JdbcTemplate(dataSource);
    }

    @Primary
    @Bean(name = "namedJdbcTemplate1")
    public NamedParameterJdbcTemplate namedJdbcTemplate1(@Qualifier("dataSource1") DataSource dataSource) {
        return new NamedParameterJdbcTemplate(dataSource);
    }

    @Primary
    @Bean(name = "tm1")
    public PlatformTransactionManager tm1(@Qualifier("dataSource1") DataSource dataSource) {
        return new DataSourceTransactionManager(dataSource);
    }
}
```

**å…³é”®ç‚¹**ï¼š
- âœ… `@Primary` æ³¨è§£æ ‡è®°ä¸ºä¸»æ•°æ®æº
- âœ… Bean åç§°ä½¿ç”¨ `dataSource1`, `jdbcTemplate1`, `tm1`
- âœ… äº‹åŠ¡ç®¡ç†å™¨å‘½åä¸º `tm1`ï¼Œç”¨äºå…ƒæ•°æ®äº‹åŠ¡

### 2.3 DataSource2Config.java

**èŒè´£**ï¼šé…ç½® db2 æ•°æ®æºã€JdbcTemplateã€äº‹åŠ¡ç®¡ç†å™¨

```java
@Configuration
public class DataSource2Config {

    @Bean(name = "dataSource2")
    @ConfigurationProperties(prefix = "spring.datasource.db2")
    public DataSource dataSource2() {
        return DataSourceBuilder.create().build();
    }

    @Bean(name = "jdbcTemplate2")
    public JdbcTemplate jdbcTemplate2(@Qualifier("dataSource2") DataSource dataSource) {
        return new JdbcTemplate(dataSource);
    }

    @Bean(name = "namedJdbcTemplate2")
    public NamedParameterJdbcTemplate namedJdbcTemplate2(@Qualifier("dataSource2") DataSource dataSource) {
        return new NamedParameterJdbcTemplate(dataSource);
    }

    @Bean(name = "tm2")
    public PlatformTransactionManager tm2(@Qualifier("dataSource2") DataSource dataSource) {
        return new DataSourceTransactionManager(dataSource);
    }
}
```

### 2.4 DataSource3/4Config.java

ç»“æ„ä¸ DataSource2Config ç±»ä¼¼ï¼Œä¿®æ”¹ Bean åç§°å’Œé…ç½®å‰ç¼€å³å¯ã€‚

---

## 3. Batch åŸºç¡€è®¾æ–½é…ç½®

### 3.1 BatchInfrastructureConfig.java

**èŒè´£**ï¼šé…ç½® JobRepositoryã€JobLauncherã€JobExplorer

**å…³é”®é…ç½®**ï¼šJobRepository å¿…é¡»ç»‘å®š tm1

```java
@Configuration
@EnableBatchProcessing
public class BatchInfrastructureConfig {

    /**
     * ğŸ”´ å…³é”®é…ç½®ï¼šJobRepository ç»‘å®š tm1ï¼ˆdb1 äº‹åŠ¡ç®¡ç†å™¨ï¼‰
     * ç¡®ä¿å…ƒæ•°æ®äº‹åŠ¡ç‹¬ç«‹äºä¸šåŠ¡äº‹åŠ¡ï¼Œå¤±è´¥æ—¶å…ƒæ•°æ®ä¹Ÿèƒ½æäº¤
     */
    @Bean
    public JobRepository jobRepository(
            @Qualifier("dataSource1") DataSource dataSource1,
            @Qualifier("tm1") PlatformTransactionManager tm1) throws Exception {

        JobRepositoryFactoryBean factory = new JobRepositoryFactoryBean();
        factory.setDataSource(dataSource1);       // âœ… ä½¿ç”¨ db1 æ•°æ®æº
        factory.setTransactionManager(tm1);       // ğŸ”´ ç»‘å®š tm1ï¼Œç¡®ä¿å…ƒæ•°æ®äº‹åŠ¡ç‹¬ç«‹
        factory.setIsolationLevelForCreate("ISOLATION_READ_COMMITTED");
        factory.setTablePrefix("BATCH_");         // Spring Batch å…ƒæ•°æ®è¡¨å‰ç¼€
        factory.afterPropertiesSet();
        return factory.getObject();
    }

    /**
     * JobLauncher é…ç½®ï¼ˆä½¿ç”¨ä¸Šé¢çš„ JobRepositoryï¼‰
     */
    @Bean
    public JobLauncher jobLauncher(JobRepository jobRepository) throws Exception {
        TaskExecutorJobLauncher jobLauncher = new TaskExecutorJobLauncher();
        jobLauncher.setJobRepository(jobRepository);
        jobLauncher.afterPropertiesSet();
        return jobLauncher;
    }

    /**
     * JobExplorer é…ç½®ï¼ˆç”¨äºæŸ¥è¯¢æ‰¹å¤„ç†æ‰§è¡Œå†å²ï¼‰
     */
    @Bean
    public JobExplorer jobExplorer(@Qualifier("dataSource1") DataSource dataSource1) throws Exception {
        JobExplorerFactoryBean factory = new JobExplorerFactoryBean();
        factory.setDataSource(dataSource1);
        factory.setTablePrefix("BATCH_");
        factory.afterPropertiesSet();
        return factory.getObject();
    }
}
```

**é…ç½®è¯´æ˜**ï¼š
- âœ… `JobRepository` ä½¿ç”¨ `dataSource1`ï¼ˆdb1ï¼‰+ `tm1`ï¼ˆdb1 äº‹åŠ¡ç®¡ç†å™¨ï¼‰
- âœ… æ‰€æœ‰å…ƒæ•°æ®æ“ä½œï¼ˆBATCH_JOB_EXECUTIONã€BATCH_STEP_EXECUTION ç­‰ï¼‰ç”± tm1 ç®¡ç†
- âœ… å³ä½¿ Step ä¸šåŠ¡é€»è¾‘å¤±è´¥ï¼ˆtm2 å›æ»šï¼‰ï¼Œå…ƒæ•°æ®ä¹Ÿä¼šæäº¤ï¼ˆtm1 ç‹¬ç«‹æäº¤ï¼‰

---

## 4. Step äº‹åŠ¡ç®¡ç†å™¨é…ç½®

### 4.1 StepBuilder æ˜¾å¼ç»‘å®šäº‹åŠ¡ç®¡ç†å™¨

```java
@Configuration
public class DemoJobConfig {

    @Value("${batch.chunk-size:100}")
    private int chunkSize;

    @Bean
    public Step importFileStep(
            JobRepository jobRepository,
            @Qualifier("tm2") PlatformTransactionManager tm2,
            ItemReader<DemoUser> reader,
            ItemProcessor<DemoUser, DemoUser> processor,
            ItemWriter<DemoUser> writer) {

        return new StepBuilder("importFileStep", jobRepository)
                .<DemoUser, DemoUser>chunk(chunkSize, tm2)  // chunk() çš„ç¬¬äºŒä¸ªå‚æ•°å°±æ˜¯äº‹åŠ¡ç®¡ç†å™¨
                .reader(reader)
                .processor(processor)
                .writer(writer)
                .faultTolerant()
                .skipLimit(10)
                .skip(FlatFileParseException.class)
                .skip(BindException.class)
                .skip(IllegalArgumentException.class)
                .build();
    }

    @Bean
    public Job demoJob(JobRepository jobRepository, Step importFileStep) {
        return new JobBuilder("demoJob", jobRepository)
                .start(importFileStep)
                .build();
    }
}
```

**å…³é”®ç‚¹**ï¼š
- âœ… `.chunk(chunkSize, tm2)` çš„ç¬¬äºŒä¸ªå‚æ•°æŒ‡å®šä¸šåŠ¡äº‹åŠ¡ç®¡ç†å™¨
- âœ… æ¯ä¸ª Step å¿…é¡»æ˜¾å¼æŒ‡å®šä¸šåŠ¡äº‹åŠ¡ç®¡ç†å™¨
- âœ… ä¸šåŠ¡äº‹åŠ¡ä¸å…ƒæ•°æ®äº‹åŠ¡å®Œå…¨éš”ç¦»

### 4.2 Service å±‚äº‹åŠ¡æ³¨è§£

```java
@Service
public class Db2BusinessService {

    private final NamedParameterJdbcTemplate namedJdbcTemplate2;

    public Db2BusinessService(@Qualifier("namedJdbcTemplate2") NamedParameterJdbcTemplate namedJdbcTemplate2) {
        this.namedJdbcTemplate2 = namedJdbcTemplate2;
    }

    @Transactional(transactionManager = "tm2", propagation = Propagation.REQUIRED)
    public void batchInsertUsers(List<DemoUser> users) {
        String sql = "INSERT INTO DEMO_USER (id, name, email) VALUES (:id, :name, :email)";
        SqlParameterSource[] batchParams = users.stream()
            .map(user -> new MapSqlParameterSource()
                .addValue("id", user.getId())
                .addValue("name", user.getName())
                .addValue("email", user.getEmail()))
            .toArray(SqlParameterSource[]::new);
        namedJdbcTemplate2.batchUpdate(sql, batchParams);
    }
}
```

**å…³é”®ç‚¹**ï¼š
- âœ… `@Transactional(transactionManager = "tm2")` æ˜¾å¼æŒ‡å®šäº‹åŠ¡ç®¡ç†å™¨
- âœ… ç¦æ­¢ä½¿ç”¨ tm1 è¿›è¡Œä¸šåŠ¡æ•°æ®æ“ä½œ
- âœ… æ¯ä¸ªæ•°æ®æºå¯¹åº”ç‹¬ç«‹çš„äº‹åŠ¡ç®¡ç†å™¨

---

## 5. äº‹åŠ¡éš”ç¦»éªŒè¯

### 5.1 éªŒè¯æµ‹è¯•

**æµ‹è¯•ç›®æ ‡**ï¼šéªŒè¯å…ƒæ•°æ®äº‹åŠ¡ç‹¬ç«‹æ€§ï¼Œç¡®ä¿ä¸šåŠ¡å¤±è´¥æ—¶å…ƒæ•°æ®ä»èƒ½æäº¤ã€‚

```java
@SpringBootTest
class TransactionIsolationTest {

    @Autowired
    private JobLauncher jobLauncher;

    @Autowired
    private Job demoJob;

    @Autowired
    @Qualifier("jdbcTemplate1")
    private JdbcTemplate jdbcTemplate1;  // å…ƒæ•°æ®åº“

    @Autowired
    @Qualifier("jdbcTemplate2")
    private JdbcTemplate jdbcTemplate2;  // ä¸šåŠ¡åº“

    @Test
    void testMetadataCommitWhenBusinessRollback() throws Exception {
        // 1. æ¸…ç©ºä¸šåŠ¡è¡¨å’Œå…ƒæ•°æ®è¡¨
        jdbcTemplate2.execute("DELETE FROM DEMO_USER");
        jdbcTemplate1.execute("DELETE FROM BATCH_JOB_EXECUTION");
        jdbcTemplate1.execute("DELETE FROM BATCH_STEP_EXECUTION");

        // 2. å‡†å¤‡ä¼šè§¦å‘å¼‚å¸¸çš„æ•°æ®ï¼ˆå¦‚åŒ…å«é‡å¤çš„ä¸»é”®ï¼‰
        // ...

        // 3. æ‰§è¡Œ Jobï¼ˆé¢„æœŸå¤±è´¥ï¼‰
        JobExecution jobExecution = jobLauncher.run(demoJob, jobParameters);

        // 4. éªŒè¯ï¼šJob æ‰§è¡ŒçŠ¶æ€ä¸º FAILED
        assertEquals(BatchStatus.FAILED, jobExecution.getStatus());

        // 5. éªŒè¯ï¼šå…ƒæ•°æ®è¡¨å·²è®°å½• FAILED çŠ¶æ€ï¼ˆtm1 æäº¤æˆåŠŸï¼‰
        Long jobExecutionCount = jdbcTemplate1.queryForObject(
            "SELECT COUNT(*) FROM BATCH_JOB_EXECUTION WHERE STATUS = 'FAILED'",
            Long.class
        );
        assertEquals(1L, jobExecutionCount);

        // 6. âœ… å…³é”®éªŒè¯ï¼šä¸šåŠ¡è¡¨æ•°æ®ä¸ºç©ºï¼ˆtm2 å›æ»šæˆåŠŸï¼‰
        Long businessDataCount = jdbcTemplate2.queryForObject(
            "SELECT COUNT(*) FROM DEMO_USER",
            Long.class
        );
        assertEquals(0L, businessDataCount, "ä¸šåŠ¡äº‹åŠ¡åº”å·²å›æ»šï¼Œä¸šåŠ¡è¡¨åº”ä¸ºç©ºï¼");
    }
}
```

### 5.2 éªŒè¯æ ‡å‡†

| éªŒè¯é¡¹ | é¢„æœŸç»“æœ | è¯´æ˜ |
|--------|----------|------|
| Job çŠ¶æ€ | FAILED | Step æ‰§è¡Œå¤±è´¥ |
| BATCH_JOB_EXECUTION | æœ‰ FAILED è®°å½• | å…ƒæ•°æ®æäº¤æˆåŠŸ |
| BATCH_STEP_EXECUTION | æœ‰ FAILED è®°å½• | å…ƒæ•°æ®æäº¤æˆåŠŸ |
| DEMO_USER | 0 æ¡è®°å½• | ä¸šåŠ¡æ•°æ®å›æ»šæˆåŠŸ |

**å¤±è´¥åœºæ™¯**ï¼šå¦‚æœä¸šåŠ¡è¡¨æœ‰æ•°æ®æ®‹ç•™ï¼Œè¯´æ˜äº‹åŠ¡éš”ç¦»é…ç½®é”™è¯¯ï¼

---

## 6. å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### 6.1 äº‹åŠ¡ç®¡ç†å™¨æœªæŒ‡å®š

**é—®é¢˜**ï¼šService å±‚æœªæŒ‡å®š transactionManager

```java
// âŒ é”™è¯¯ç¤ºä¾‹
@Transactional
public void batchInsertUsers(List<DemoUser> users) {
    // ä½¿ç”¨é»˜è®¤äº‹åŠ¡ç®¡ç†å™¨ï¼ˆå¯èƒ½æ˜¯ tm1ï¼‰
}
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```java
// âœ… æ­£ç¡®ç¤ºä¾‹
@Transactional(transactionManager = "tm2", propagation = Propagation.REQUIRED)
public void batchInsertUsers(List<DemoUser> users) {
    // æ˜¾å¼æŒ‡å®šä½¿ç”¨ tm2
}
```

### 6.2 Step æœªç»‘å®šä¸šåŠ¡äº‹åŠ¡ç®¡ç†å™¨

**é—®é¢˜**ï¼šStep æœªæŒ‡å®š transactionManager

```java
// âŒ é”™è¯¯ç¤ºä¾‹
return new StepBuilder("importFileStep", jobRepository)
    .<DemoUser, DemoUser>chunk(100)  // æœªæŒ‡å®šäº‹åŠ¡ç®¡ç†å™¨
    .reader(reader)
    .writer(writer)
    .build();
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```java
// âœ… æ­£ç¡®ç¤ºä¾‹
return new StepBuilder("importFileStep", jobRepository)
    .<DemoUser, DemoUser>chunk(100, tm2)  // æ˜¾å¼æŒ‡å®š tm2
    .reader(reader)
    .writer(writer)
    .build();
```

### 6.3 è·¨åº“äº‹åŠ¡é—®é¢˜

**é—®é¢˜**ï¼šå•ä¸ª Step ä¸­éœ€è¦å†™å…¥å¤šä¸ªæ•°æ®æº

**è§£å†³æ–¹æ¡ˆ**ï¼š

```java
// æ–¹æ¡ˆ1: æ‹†åˆ†ä¸ºå¤šä¸ª Stepï¼Œæ¯ä¸ª Step æ“ä½œä¸€ä¸ªæ•°æ®æº
@Bean
public Job multiDatabaseJob(JobRepository jobRepository,
                            Step step1ToDb2,
                            Step step2ToDb3) {
    return new JobBuilder("multiDatabaseJob", jobRepository)
        .start(step1ToDb2)
        .next(step2ToDb3)
        .build();
}

// æ–¹æ¡ˆ2: ä½¿ç”¨åˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆä¸æ¨èï¼Œå¢åŠ å¤æ‚åº¦ï¼‰
// å¦‚å¿…é¡»ä½¿ç”¨ï¼Œè€ƒè™‘å¼•å…¥ Seata/Atomikos
```

### 6.4 è¿æ¥æ± è€—å°½

**é—®é¢˜**ï¼šå¹¶å‘æ‰§è¡Œå¤šä¸ª Job æ—¶è¿æ¥æ± è€—å°½

**è§£å†³æ–¹æ¡ˆ**ï¼š

```yaml
spring:
  datasource:
    db1:
      hikari:
        maximum-pool-size: 20      # å¢åŠ æœ€å¤§è¿æ¥æ•°
        minimum-idle: 10           # å¢åŠ æœ€å°ç©ºé—²è¿æ¥
        connection-timeout: 30000  # å¢åŠ è¿æ¥è¶…æ—¶
```

---

## 7. æœ€ä½³å®è·µ

### 7.1 å‘½åè§„èŒƒ

| ç»„ä»¶ | å‘½åè§„èŒƒ | ç¤ºä¾‹ |
|------|----------|------|
| DataSource | `dataSource{N}` | `dataSource1`, `dataSource2` |
| JdbcTemplate | `jdbcTemplate{N}` | `jdbcTemplate1`, `jdbcTemplate2` |
| TransactionManager | `tm{N}` | `tm1`, `tm2` |
| Service | `{DbName}BusinessService` | `Db2BusinessService` |

### 7.2 é…ç½®æ£€æŸ¥æ¸…å•

- [ ] `application.yml` é…ç½®äº†æ‰€æœ‰æ•°æ®æº
- [ ] `DataSource1Config` æ ‡è®°äº† `@Primary`
- [ ] `BatchInfrastructureConfig` çš„ JobRepository ç»‘å®šäº† tm1
- [ ] æ¯ä¸ª Step æ˜¾å¼æŒ‡å®šäº†ä¸šåŠ¡äº‹åŠ¡ç®¡ç†å™¨
- [ ] Service å±‚ `@Transactional` æŒ‡å®šäº† transactionManager
- [ ] è¿æ¥æ± é…ç½®åˆç†ï¼ˆé¿å…è¿æ¥æ± è€—å°½ï¼‰
- [ ] äº‹åŠ¡éš”ç¦»éªŒè¯æµ‹è¯•é€šè¿‡

### 7.3 æ€§èƒ½ä¼˜åŒ–

| ä¼˜åŒ–é¡¹ | è¯´æ˜ | æ¨èå€¼ |
|--------|------|--------|
| è¿æ¥æ± å¤§å° | æ ¹æ®å¹¶å‘åº¦è°ƒæ•´ | 10-20 |
| Chunk å¤§å° | å¹³è¡¡æ€§èƒ½ä¸å†…å­˜ | 100-1000 |
| è¿æ¥è¶…æ—¶ | é¿å…é•¿æ—¶é—´ç­‰å¾… | 30ç§’ |
| ç©ºé—²è¶…æ—¶ | é‡Šæ”¾ç©ºé—²è¿æ¥ | 10åˆ†é’Ÿ |

---

## 8. é™„å½•

### 8.1 å…ƒæ•°æ®è¡¨è¯´æ˜

| è¡¨å | è¯´æ˜ |
|------|------|
| BATCH_JOB_INSTANCE | Job å®ä¾‹ï¼ˆå‚æ•°ä¸åŒåˆ™ä¸åŒå®ä¾‹ï¼‰ |
| BATCH_JOB_EXECUTION | Job æ‰§è¡Œè®°å½•ï¼ˆæ¯æ¬¡æ‰§è¡Œä¸€æ¡è®°å½•ï¼‰ |
| BATCH_JOB_EXECUTION_PARAMS | Job æ‰§è¡Œå‚æ•° |
| BATCH_STEP_EXECUTION | Step æ‰§è¡Œè®°å½• |
| BATCH_STEP_EXECUTION_CONTEXT | Step æ‰§è¡Œä¸Šä¸‹æ–‡ |

### 8.2 äº‹åŠ¡éš”ç¦»çº§åˆ«

```java
// JobRepository é…ç½®
factory.setIsolationLevelForCreate("ISOLATION_READ_COMMITTED");
```

| éš”ç¦»çº§åˆ« | è¯´æ˜ |
|----------|------|
| ISOLATION_READ_COMMITTED | è¯»å–å·²æäº¤æ•°æ®ï¼ˆæ¨èï¼‰ |
| ISOLATION_READ_UNCOMMITTED | è¯»å–æœªæäº¤æ•°æ®ï¼ˆä¸æ¨èï¼‰ |
| ISOLATION_REPEATABLE_READ | å¯é‡å¤è¯» |
| ISOLATION_SERIALIZABLE | ä¸²è¡ŒåŒ–ï¼ˆæ€§èƒ½å·®ï¼‰ |

---

**æ–‡æ¡£ç»“æŸ**
