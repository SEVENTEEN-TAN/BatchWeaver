# 测试案例文档

本文档描述 BatchWeaver 框架的测试用例和验证方法。

## 单元测试

### HeaderFooterAwareReader 测试

#### 测试类位置
```
src/test/java/com/batchweaver/core/fileprocess/reader/HeaderFooterAwareReaderTest.java
```

#### 测试场景

| 场景 | 描述 | 预期结果 |
|------|------|----------|
| 正常流程 | Header + 数据 + Footer | 校验通过，数据行正确返回 |
| Header 校验失败 | Header 日期不匹配 | 抛出 IllegalStateException |
| Footer 校验失败 | Footer count 与实际不符 | 抛出 IllegalStateException |
| 无 Header | 文件无首行 | 正常处理所有行 |
| 无 Footer | 文件无尾行 | 最后一行作为数据处理 |
| 空文件 | 文件为空 | 返回 null |
| 单行数据 | 仅一行数据 | 根据配置判断为 Header 或数据 |
| 单行 Footer | 仅一行 Footer | 识别为 Footer，返回 null |

#### 测试代码示例

```java
@Test
public void testHeaderFooterValidation_Success() throws Exception {
    // Arrange
    String fileContent = "20260120\n" +
                        "张三,25,zhangsan@example.com,1990-01-15\n" +
                        "李四,30,lisi@example.com,1985-06-20\n" +
                        "2";

    Resource resource = new ByteArrayResource(fileContent.getBytes(StandardCharsets.UTF_8));

    HeaderParser headerParser = line -> new HeaderInfo(LocalDate.parse(line, DateTimeFormatter.ofPattern("yyyyMMdd")));
    HeaderValidator headerValidator = header -> {
        if (!header.getDate().equals(LocalDate.now())) {
            throw new IllegalStateException("日期不匹配");
        }
    };
    FooterParser footerParser = line -> new FooterInfo(Long.parseLong(line.trim()));
    FooterValidator footerValidator = (footer, actual) -> {
        if (footer.getCount() != actual) {
            throw new IllegalStateException("数量不匹配");
        }
    };

    HeaderFooterAwareReader<User> reader = new HeaderFooterAwareReader<>(
        resource, headerParser, headerValidator, footerParser, footerValidator,
        new DelimitedLineTokenizer(),
        new AnnotationDrivenFieldSetMapper<>(User.class)
    );

    reader.open(new ExecutionContext());

    // Act
    User user1 = reader.read();
    User user2 = reader.read();
    User user3 = reader.read();

    // Assert
    assertNotNull(user1);
    assertNotNull(user2);
    assertNull(user3); // 应该返回 null（EOF）
    assertEquals("张三", user1.getName());
    assertEquals("李四", user2.getName());

    reader.close();
}
```

---

## 集成测试

### 事务隔离验证测试

#### 测试类位置
```
src/test/java/com/batchweaver/config/TransactionIsolationTest.java
```

#### 测试场景

| 场景 | 描述 | 验证标准 |
|------|------|----------|
| 业务事务回滚 | Step 执行失败，业务数据回滚 | ✅ 元数据提交（FAILED 记录）<br>✅ 业务表为空 |
| 元数据事务提交 | Step 执行失败，元数据正常提交 | ✅ BATCH_JOB_EXECUTION 有 FAILED 记录 |

#### 测试代码

```java
@Test
public void testMetadataCommitWhenBusinessRollback() {
    // Arrange
    Job job = jobLauncher.launchJob();

    // Act - 故意使业务事务失败
    // ...

    // Assert
    // 验证元数据表有 FAILED 记录
    // 验证业务表为空
}
```

---

## 性能测试

### 大文件处理测试

#### 测试场景

| 文件大小 | 数据行数 | 预期耗时 |
|---------|---------|----------|
| 10 MB | ~10,000 行 | < 5 秒 |
| 100 MB | ~100,000 行 | < 30 秒 |
| 1 GB | ~1,000,000 行 | < 5 分钟 |

#### 性能指标

- **启动延迟**: < 100ms（零预扫描）
- **内存占用**: < 50 MB（O(1) 缓存）
- **吞吐量**: > 10,000 行/秒

#### 测试代码

```java
@Test
public void testLargeFileProcessing() throws Exception {
    // 生成 1GB 测试文件
    Path testFile = Files.createTempFile("large-test", ".txt");
    try (BufferedWriter writer = Files.newBufferedWriter(testFile, StandardCharsets.UTF_8)) {
        writer.write("20260120\n");
        for (int i = 0; i < 1_000_000; i++) {
            writer.write("User" + i + ",25,user" + i + "@example.com,1990-01-15\n");
        }
        writer.write("1000000\n");
    }

    FileSystemResource resource = new FileSystemResource(testFile.toFile());

    HeaderFooterAwareReader<User> reader = new HeaderFooterAwareReader<>(...);

    long startTime = System.currentTimeMillis();
    reader.open(new ExecutionContext());

    User user;
    int count = 0;
    while ((user = reader.read()) != null) {
        count++;
    }

    long endTime = System.currentTimeMillis();

    // Assert
    assertEquals(1_000_000, count);
    assertTrue((endTime - startTime) < 300000); // 5 分钟内完成

    reader.close();
}
```

---

## 边界条件测试

### 异常输入测试

| 场景 | 输入 | 预期行为 |
|------|------|----------|
| 空 Header | Header 行为空 | 抛出异常 |
| 空 Footer | Footer 行为空 | 跳过校验或使用默认值 |
| 非数字 Footer | Footer 格式错误 | 抛出异常或跳过 |
| CSV 注入 | 包含危险字符 | 自动转义 |
| 路径遍历 | 文件路径包含 `..` | 拒绝访问 |

### CSV 注入防护测试

```java
@Test
public void testCsvInjectionProtection() {
    String maliciousLine = "=1+1";

    // CSV 注入防护器应该转义危险字符
    String sanitized = CsvInjectionSanitizer.sanitize(maliciousLine);

    // Assert
    assertFalse(sanitized.contains("="));
}
```

---

## 端到端测试

### 完整导入流程测试

#### 测试步骤

1. 准备测试文件
2. 配置 Job
3. 执行 Job
4. 验证数据库结果
5. 验证元数据表

#### 测试数据

**输入文件** (`test_users.txt`):
```
20260120
1,Alice,alice@example.com,1995-05-10
2,Bob,bob@example.com,1988-12-15
3,Charlie,charlie@example.com,1992-03-20
3
```

**预期结果**:
- ✅ 3 条记录导入成功
- ✅ Header 校验通过（日期匹配）
- ✅ Footer 校验通过（count = 3）

---

## 测试运行

### 运行所有测试

```bash
mvn test
```

### 运行特定测试

```bash
# 只运行 Reader 测试
mvn test -Dtest=HeaderFooterAwareReaderTest

# 只运行事务隔离测试
mvn test -Dtest=TransactionIsolationTest

# 只运行性能测试
mvn test -Dtest=PerformanceTest
```

### 测试覆盖率

```bash
mvn clean test jacoco:report
```

---

## 故障排查

### 常见测试失败原因

| 问题 | 可能原因 | 解决方案 |
|------|----------|----------|
| Header 校验失败 | 系统日期与文件日期不匹配 | 更新文件日期或调整校验逻辑 |
| Footer 校验失败 | 数据行数与 Footer count 不符 | 检查文件内容，确保数据完整 |
| 事务隔离失效 | JobRepository 未绑定 tm1 | 检查 BatchInfrastructureConfig 配置 |
| 连接池耗尽 | 测试未正确关闭连接 | 使用 `@AfterEach` 清理资源 |

---

## 测试最佳实践

1. **使用 `@TempDir`** - 为每个测试创建临时目录
2. **清理资源** - 使用 `@AfterEach` 确保 Reader/Writer 正确关闭
3. **隔离测试** - 每个测试独立，不依赖其他测试
4. **使用事务回滚** - 测试完成后回滚数据，保持数据库干净
5. **模拟真实场景** - 使用与生产环境相同的数据格式
