# Spring Batch 文件导入/导出示例

## 场景说明

本示例演示：
1. **文件导入**：从 CSV 文件读取用户数据，带头校验（日期）和尾校验（记录数）
2. **数据导出**：将数据库数据导出为 CSV 文件，自动生成头尾

---

## 1. 数据文件格式

### 导入文件格式 (`users_import.csv`)

```csv
H|20260120
张三,25,zhangsan@example.com,1990-01-15
李四,30,lisi@example.com,1985-06-20
王五,28,wangwu@example.com,1987-03-10
3
```

**格式说明**：
- 第1行 `H|20260120`: Header（头），包含业务日期
- 第2-4行: 业务数据（姓名,年龄,邮箱,出生日期）
- 第5行 `3`: Footer（尾），声明记录总数

### 导出文件格式 (`users_export.csv`)

```csv
20260120
张三,25,zhangsan@example.com,1990-01-15
李四,30,lisi@example.com,1985-06-20
王五,28,wangwu@example.com,1987-03-10
3
```

---

## 2. 实体类

```java
package com.batchweaver.batch.entity;

import com.batchweaver.core.annotation.FileColumn;
import lombok.Data;

/**
 * 用户实体 - 用于文件导入/导出
 */
@Data
public class User {

    @FileColumn(index = 0, name = "userName", trim = true, toUpperCase = false)
    private String name;

    @FileColumn(index = 1, name = "age")
    private Integer age;

    @FileColumn(index = 2, name = "email", trim = true, defaultValue = "unknown@example.com")
    private String email;

    @FileColumn(index = 3, name = "birthDate")
    private String birthDate;  // 使用 String 类型，格式: yyyy-MM-dd
}
```

---

## 3. 文件导入 Job 配置

```java
package com.batchweaver.batch.job;

import com.batchweaver.batch.entity.User;
import com.batchweaver.core.fileprocess.function.*;
import com.batchweaver.core.fileprocess.model.FooterInfo;
import com.batchweaver.core.fileprocess.model.HeaderInfo;
import com.batchweaver.core.fileprocess.template.FileImportJobTemplate;
import com.batchweaver.core.reader.AnnotationDrivenFieldSetMapper;
import com.batchweaver.core.writer.JdbcBatchItemWriterFactory;
import lombok.extern.slf4j.Slf4j;
import org.springframework.batch.core.Job;
import org.springframework.batch.core.repository.JobRepository;
import org.springframework.batch.item.ItemReader;
import org.springframework.batch.item.ItemWriter;
import org.springframework.batch.item.file.FlatFileItemReader;
import org.springframework.batch.item.file.builder.FlatFileItemReaderBuilder;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.core.io.FileSystemResource;
import org.springframework.transaction.PlatformTransactionManager;
import org.springframework.jdbc.core.JdbcTemplate;

import java.time.LocalDate;
import java.time.format.DateTimeFormatter;

/**
 * 用户导入 Job 配置
 * <p>
 * 演示：带头尾校验的文件导入
 */
@Slf4j
@Configuration
public class UserImportJobConfig {

    /**
     * 文件导入 Job
     * <p>
     * 流程：
     * 1. beforeStep: 校验 Header 日期 + 解析 Footer 获取声明记录数
     * 2. FooterFilterListener: 设置 maxItemCount，确保 Footer 行不被读取
     * 3. 读取业务数据并写入数据库
     * 4. afterStep: 校验 Footer 记录数与实际写入数
     */
    @Bean
    public Job userImportJob(JobRepository jobRepository,
                             @Qualifier("tm2") PlatformTransactionManager tm2,
                             JdbcTemplate jdbcTemplate2) {

        // ========================================
        // 1. Reader - 文件读取器
        // ========================================
        FlatFileItemReader<User> reader = new FlatFileItemReaderBuilder<User>()
                .name("userImportReader")
                .resource(new FileSystemResource("data/input/users_import.csv"))
                .delimited()
                .delimiter(",")
                .names("name", "age", "email", "birthDate")
                .fieldSetMapper(new AnnotationDrivenFieldSetMapper<>(User.class))
                .linesToSkip(1)  // 跳过 Header 行
                .build();

        // ========================================
        // 2. Writer - 数据库写入器
        // ========================================
        String sql = "INSERT INTO USERS (name, age, email, birth_date) " +
                     "VALUES (:name, :age, :email, :birthDate)";

        ItemWriter<User> writer = JdbcBatchItemWriterFactory.create(
                jdbcTemplate2.getDataSource(),
                sql,
                User.class
        );

        // ========================================
        // 3. Header 校验 - 日期必须是今天
        // ========================================
        HeaderParser headerParser = line -> {
            // 去掉 H| 前缀，解析日期
            String dateStr = line.substring(2);
            LocalDate date = LocalDate.parse(dateStr, DateTimeFormatter.ofPattern("yyyyMMdd"));
            return new HeaderInfo(date);
        };

        HeaderValidator headerValidator = header -> {
            LocalDate today = LocalDate.now();
            if (!header.getDate().equals(today)) {
                throw new IllegalStateException(
                        String.format("Header date mismatch: expected=%s, actual=%s",
                                today, header.getDate())
                );
            }
            log.info("Header validation passed: date={}", header.getDate());
        };

        // ========================================
        // 4. Footer 校验 - 记录数必须匹配
        // ========================================
        FooterParser footerParser = line -> {
            // 解析 Footer 行的记录数
            long count = Long.parseLong(line.trim());
            return new FooterInfo(count);
        };

        FooterValidator footerValidator = (footer, actualCount) -> {
            long declaredCount = footer.getCount();
            if (declaredCount != actualCount) {
                throw new IllegalStateException(
                        String.format("Footer count mismatch: declared=%d, actual=%d",
                                declaredCount, actualCount)
                );
            }
            log.info("Footer validation passed: declared={}, actual={}",
                    declaredCount, actualCount);
        };

        // ========================================
        // 5. 使用模板构建 Job
        // ========================================
        FileImportJobTemplate.FileImportJobDefinition<User, User> definition =
                FileImportJobTemplate.FileImportJobDefinition.<User, User>builder()
                        .jobName("userImportJob")
                        .stepName("userImportStep")
                        .jobRepository(jobRepository)
                        .transactionManager(tm2)
                        .reader(reader)
                        .writer(writer)
                        .resource(new FileSystemResource("data/input/users_import.csv"))
                        // Header 配置
                        .headerParser(headerParser)
                        .headerValidator(headerValidator)
                        // Footer 配置
                        .footerParser(footerParser)
                        .footerValidator(footerValidator)
                        // 性能配置
                        .chunkSize(100)
                        // 错误处理
                        .skipLimit(10)
                        .build();

        FileImportJobTemplate template = new FileImportJobTemplate();
        return template.buildJob(definition);
    }
}
```

---

## 4. 文件导出 Job 配置

```java
package com.batchweaver.batch.job;

import com.batchweaver.batch.entity.User;
import com.batchweaver.core.fileprocess.function.FooterGenerator;
import com.batchweaver.core.fileprocess.function.HeaderGenerator;
import com.batchweaver.core.fileprocess.template.FileExportJobTemplate;
import lombok.extern.slf4j.Slf4j;
import org.springframework.batch.core.Job;
import org.springframework.batch.core.repository.JobRepository;
import org.springframework.batch.item.ItemReader;
import org.springframework.batch.item.database.JdbcPagingItemReader;
import org.springframework.batch.item.database.Order;
import org.springframework.batch.item.database.support.MySqlPagingQueryProvider;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.core.io.FileSystemResource;
import org.springframework.transaction.PlatformTransactionManager;
import org.springframework.jdbc.core.BeanPropertyRowMapper;

import java.time.LocalDate;
import java.time.format.DateTimeFormatter;
import java.util.LinkedHashMap;
import java.util.Map;

/**
 * 用户导出 Job 配置
 * <p>
 * 演示：自动生成头尾的文件导出
 */
@Slf4j
@Configuration
public class UserExportJobConfig {

    /**
     * 文件导出 Job
     * <p>
     * 流程：
     * 1. 从数据库读取用户数据
     * 2. 写入 CSV 文件
     * 3. 自动生成 Header（日期）
     * 4. 自动生成 Footer（记录数）
     */
    @Bean
    public Job userExportJob(JobRepository jobRepository,
                             @Qualifier("tm2") PlatformTransactionManager tm2,
                             @Qualifier("dataSource2") DataSource dataSource2) throws Exception {

        // ========================================
        // 1. Reader - 数据库读取器
        // ========================================
        JdbcPagingItemReader<User> reader = new JdbcPagingItemReader<>();
        reader.setDataSource(dataSource2);
        reader.setSql("SELECT name, age, email, birth_date as birthDate FROM USERS ORDER BY id");
        reader.setRowMapper(new BeanPropertyRowMapper<>(User.class));
        reader.setPageSize(100);
        reader.afterPropertiesSet();

        // ========================================
        // 2. Header 生成器 - yyyyMMdd 格式
        // ========================================
        HeaderGenerator headerGenerator = date ->
                date.format(DateTimeFormatter.ofPattern("yyyyMMdd"));

        // ========================================
        // 3. Footer 生成器 - 纯数字记录数
        // ========================================
        FooterGenerator footerGenerator = count -> String.valueOf(count);

        // ========================================
        // 4. 使用模板构建 Job
        // ========================================
        FileExportJobTemplate.FileExportJobDefinition<User> definition =
                FileExportJobTemplate.FileExportJobDefinition.<User>builder()
                        .jobName("userExportJob")
                        .stepName("userExportStep")
                        .jobRepository(jobRepository)
                        .transactionManager(tm2)
                        .reader(reader)
                        .resource(new FileSystemResource("data/output/users_export.csv"))
                        .entityClass(User.class)
                        .delimiter(",")
                        // 头尾生成
                        .headerGenerator(headerGenerator)
                        .footerGenerator(footerGenerator)
                        // 性能配置
                        .chunkSize(100)
                        .build();

        FileExportJobTemplate template = new FileExportJobTemplate();
        return template.buildJob(definition);
    }
}
```

---

## 5. Job 启动器

```java
package com.batchweaver.batch.launcher;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.batch.core.Job;
import org.springframework.batch.core.JobParameters;
import org.springframework.batch.core.JobParametersBuilder;
import org.springframework.batch.core.launch.JobLauncher;
import org.springframework.boot.CommandLineRunner;
import org.springframework.stereotype.Component;

/**
 * Job 启动器 - 用于演示
 * <p>
 * 使用方式：
 * java -jar app.jar --job=import  # 执行导入 Job
 * java -jar app.jar --job=export  # 执行导出 Job
 */
@Slf4j
@Component
@RequiredArgsConstructor
public class JobLauncher implements CommandLineRunner {

    private final JobLauncher jobLauncher;
    private final Job userImportJob;
    private final Job userExportJob;

    @Override
    public void run(String... args) throws Exception {
        String jobType = System.getProperty("job", "import");

        JobParameters params = new JobParametersBuilder()
                .addLong("timestamp", System.currentTimeMillis())
                .toJobParameters();

        if ("export".equalsIgnoreCase(jobType)) {
            log.info("Launching user export job...");
            jobLauncher.run(userExportJob, params);
        } else {
            log.info("Launching user import job...");
            jobLauncher.run(userImportJob, params);
        }
    }
}
```

---

## 6. 执行流程说明

### 导入流程

```
┌─────────────────────────────────────────────────────────────┐
│  Step 开始                                                   │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ beforeStep:                                          │   │
│  │ 1. HeaderFooterListener.beforeStep()                │   │
│  │    - 读取并校验 Header: H|20260120                  │   │
│  │    - 解析 Footer: 3                                 │   │
│  │    - 存入 ExecutionContext: declaredRecordCount=3    │   │
│  └─────────────────────────────────────────────────────┘   │
│                          ↓                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ beforeStep (FooterFilterListener):                   │   │
│  │ - 从 ExecutionContext 获取 declaredRecordCount=3      │   │
│  │ - 设置 Reader.setMaxItemCount(3)                     │   │
│  └─────────────────────────────────────────────────────┘   │
│                          ↓                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 读取数据:                                            │   │
│  │ - Reader 只读取 3 行业务数据                        │   │
│  │ - Footer 行被跳过                                   │   │
│  └─────────────────────────────────────────────────────┘   │
│                          ↓                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ afterStep:                                           │   │
│  │ - HeaderFooterListener.afterStep()                  │   │
│  │ - 使用 readCount - skipCount 校验 Footer             │   │
│  │   declared=3, actual=3 ✓                            │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 导出流程

```
┌─────────────────────────────────────────────────────────────┐
│  1. 从数据库读取数据                                         │
│     SELECT * FROM USERS ORDER BY id                         │
├─────────────────────────────────────────────────────────────┤
│  2. 写入 CSV 文件                                            │
│     - 自动生成 Header: 20260120                             │
│     - 写入业务数据                                           │
│     - 自动生成 Footer: 3                                    │
├─────────────────────────────────────────────────────────────┤
│  3. 输出文件                                                 │
│     data/output/users_export.csv                            │
└─────────────────────────────────────────────────────────────┘
```

---

## 7. 测试数据文件

创建测试文件 `data/input/users_import.csv`:

```csv
H|20260120
张三,25,zhangsan@example.com,1990-01-15
李四,30,lisi@example.com,1985-06-20
王五,28,wangwu@example.com,1987-03-10
3
```

---

## 8. 运行测试

```bash
# 编译
mvn clean package

# 导入测试
java -jar target/batchweaver.jar --job=import

# 导出测试
java -jar target/batchweaver.jar --job=export
```

---

## 9. 输出日志示例

```
2026-01-20 10:00:00 INFO  - Reading header line: H|20260120
2026-01-20 10:00:00 INFO  - Parsed header: HeaderInfo(date=2026-01-20)
2026-01-20 10:00:00 INFO  - Header validation passed: date=2026-01-20
2026-01-20 10:00:00 INFO  - Reading footer line for record count: 3
2026-01-20 10:00:00 INFO  - Footer parsed: declared record count = 3
2026-01-20 10:00:00 INFO  - Set maxItemCount to 3 to exclude footer line from data reading
2026-01-20 10:00:01 INFO  - Footer validation passed: declared=3, actual=3
```
