# BatchWeaver 架构重构说明

## 文档更新日期
2026-01-22

## 重构概述

本次重构对 BatchWeaver 项目进行了全面的架构优化，引入了工厂模式、配置分层和接口-实现模式。

---

## 主要变更

### 1. 工厂模式引入 ⭐

#### 新增工厂类

**位置**: `com.batchweaver.core.factory`

| 类名 | 职责 | 优势 |
|------|------|------|
| `BatchReaderFactory` | 统一创建和初始化 `JdbcPagingItemReader` | 自动调用 `afterPropertiesSet()`，避免 NullPointerException |
| `BatchWriterFactory` | 创建 `FlatFileItemWriter` 并返回 `StreamableWriter` | 强制 stream 注册，避免 WriterNotOpenException |

#### 使用示例

**之前**（手动初始化）:
```java
JdbcPagingItemReader<DemoUser> reader = new JdbcPagingItemReader<>();
reader.setName("myReader");
reader.setDataSource(dataSource);
reader.setQueryProvider(queryProvider);
reader.setRowMapper(new BeanPropertyRowMapper<>(DemoUser.class));
reader.setPageSize(100);
reader.afterPropertiesSet();  // 容易遗漏！
```

**现在**（工厂模式）:
```java
@Autowired
private BatchReaderFactory readerFactory;

JdbcPagingItemReader<DemoUser> reader = readerFactory.createJdbcPagingReader(
    "myReader",
    dataSource,
    queryProvider,
    DemoUser.class,
    100
);  // 自动初始化，无需手动调用 afterPropertiesSet()
```

---

### 2. 配置分层架构 ⭐

#### 新增目录结构

```
demo/config/
├── components/          # ⭐ 新增：共享组件配置
│   ├── SharedWritersConfig.java
│   ├── SharedListenersConfig.java
│   └── SharedProcessorsConfig.java
└── jobs/                # ⭐ 新增：作业配置
    ├── ChunkProcessingConfig.java
    ├── ComplexWorkflowConfig.java
    ├── ConditionalFlowConfig.java
    ├── DemoJobConfig.java
    ├── FileExportConfig.java
    └── FileImportConfig.java
```

#### 配置分层说明

| 层级 | 目录 | 职责 | 示例 |
|------|------|------|------|
| **基础设施层** | `core/config` | 数据源、事务管理器、JobRepository | `BatchInfrastructureConfig` |
| **工厂层** | `core/factory` | Reader/Writer 创建工厂 | `BatchReaderFactory` |
| **共享组件层** | `demo/config/components` | 可复用的 Listener/Processor/Writer | `SharedListenersConfig` |
| **作业层** | `demo/config/jobs` | 具体的 Job 配置 | `FileExportConfig` |

#### 共享组件详情

**SharedWritersConfig.java**:
- `db2DemoUserWriter` - DB2 用户写入器
- `db3DemoUserWriter` - DB3 用户写入器
- `db4DemoUserWriter` - DB4 用户写入器

**SharedListenersConfig.java**:
- `chunkExecutionListener` - Chunk 执行监听器
- `StepExecutionListenerImpl` - Step 执行监听器
- `footerValidationListener` - Footer 校验监听器

**SharedProcessorsConfig.java**:
- `demoUserInputToDemoUserCopyIdProcessor` - 保留 ID 的转换器
- `demoUserInputToDemoUserNoIdProcessor` - 不保留 ID 的转换器

---

### 3. 接口-实现模式 ⭐

#### 业务服务重构

**位置**: `com.batchweaver.demo.shared.service`

```
service/
├── Db2BusinessService.java          # 接口
├── Db3BusinessService.java          # 接口
├── Db4BusinessService.java          # 接口
├── MockMailSender.java               # 接口
└── impl/                             # ⭐ 新增：实现类目录
    ├── Db2BusinessServiceImpl.java  # 实现
    ├── Db3BusinessServiceImpl.java  # 实现
    ├── Db4BusinessServiceImpl.java  # 实现
    └── LogOnlyMockMailSender.java   # 实现
```

#### 优势

1. **面向接口编程** - 依赖接口而非具体实现
2. **提升可测试性** - 便于使用 Mock 框架
3. **统一架构风格** - 整个服务层采用一致的模式
4. **向后兼容** - Spring 自动注入接口类型，无需修改使用方代码

---

### 4. 内部类组织 ⭐

#### ComplexWorkflowConfig 重构

**之前**: 343行扁平结构，7个 Step 方法混在一起

**现在**: 使用静态内部类按功能分组

```java
@Configuration
public class ComplexWorkflowConfig {

    @Bean
    public Job complexWorkflowJob(...) { ... }

    @Configuration
    static class ImportStepConfig { ... }

    @Configuration
    static class SyncStepsConfig { ... }

    @Configuration
    static class DecisionConfig { ... }

    @Configuration
    static class NotificationStepsConfig { ... }

    @Configuration
    static class ExportStepConfig { ... }
}
```

#### 优势

- 按功能模块组织代码
- 提升可读性和导航性
- 保持所有 Bean 名称不变

---

## 目录结构对比

### 之前

```
src/main/java/com/batchweaver/
├── core/
│   ├── config/
│   ├── fileprocess/
│   └── ...
└── demo/
    ├── config/                    # 所有配置混在一起
    │   ├── ChunkProcessingConfig.java
    │   ├── FileExportConfig.java
    │   └── ...
    └── shared/
        ├── entity/
        └── service/               # 直接是实现类
            ├── Db2BusinessService.java
            └── ...
```

### 现在

```
src/main/java/com/batchweaver/
├── core/
│   ├── config/
│   ├── factory/                   # ⭐ 新增
│   │   ├── BatchReaderFactory.java
│   │   └── BatchWriterFactory.java
│   ├── fileprocess/
│   └── ...
└── demo/
    ├── config/
    │   ├── components/            # ⭐ 新增：共享组件
    │   │   ├── SharedWritersConfig.java
    │   │   ├── SharedListenersConfig.java
    │   │   └── SharedProcessorsConfig.java
    │   └── jobs/                  # ⭐ 新增：作业配置
    │       ├── ChunkProcessingConfig.java
    │       ├── FileExportConfig.java
    │       └── ...
    └── shared/
        ├── entity/
        └── service/               # 接口
            ├── Db2BusinessService.java
            └── impl/              # ⭐ 新增：实现类
                ├── Db2BusinessServiceImpl.java
                └── ...
```

---

## 重构收益

### 代码质量

- ✅ 消除了重复代码
- ✅ 统一了生命周期管理
- ✅ 建立了清晰的分层结构
- ✅ 提升了代码可读性

### 可维护性

- ✅ 新作业只需在 jobs/ 目录添加配置
- ✅ 共享组件集中在 components/ 目录
- ✅ 工厂类封装了复杂的初始化逻辑
- ✅ 内部类组织使复杂配置更易理解

### 向后兼容性

- ✅ 所有 Bean 名称保持不变
- ✅ 所有作业正常注册（10个作业）
- ✅ 编译成功，无错误
- ✅ 运行时验证通过

---

## 迁移指南

### 如果您要创建新的 Job

1. **在 `demo/config/jobs/` 目录创建配置类**
2. **使用工厂创建 Reader**:
   ```java
   @Autowired
   private BatchReaderFactory readerFactory;

   JdbcPagingItemReader<T> reader = readerFactory.createJdbcPagingReader(...);
   ```
3. **使用共享组件**:
   ```java
   @Bean
   public Step myStep(
       JobRepository jobRepository,
       ItemWriter<DemoUser> db2DemoUserWriter,  // 自动注入共享 Writer
       ItemProcessor<DemoUserInput, DemoUser> demoUserInputToDemoUserNoIdProcessor,  // 自动注入共享 Processor
       PlatformTransactionManager tm2) {
       // ...
   }
   ```

### 如果您要创建新的业务服务

1. **在 `service/` 目录创建接口**
2. **在 `service/impl/` 目录创建实现类**
3. **实现类使用 `@Service` 注解**

---

## 相关文档

- [重构总结](.claude/refactoring-summary.md) - 详细的重构过程记录
- [README.md](../README.md) - 项目概述和快速开始
- [技术框架.md](技术框架.md) - 框架架构详解

---

**更新日期**: 2026-01-22
**版本**: 1.0.0
**状态**: ✅ 已完成
