# BatchWeaver æµ‹è¯•æ–‡æ¡£

## æ–‡æ¡£ä¿¡æ¯

| é¡¹ç›® | å†…å®¹ |
|------|------|
| **æ–‡æ¡£ç‰ˆæœ¬** | 1.1.0 |
| **åˆ›å»ºæ—¥æœŸ** | 2026-01-20 |
| **æ›´æ–°æ—¥æœŸ** | 2026-01-20 |
| **é€‚ç”¨æ¡†æ¶** | BatchWeaver (åŸºäº Spring Batch 5.x) |
| **æµ‹è¯•ç¯å¢ƒ** | Java 21 + Spring Boot 3.5.7 + SQL Server 2022 |

---

## 1. æµ‹è¯•ç¯å¢ƒé…ç½®

### 1.1 ç¯å¢ƒè¦æ±‚

| ç»„ä»¶ | ç‰ˆæœ¬è¦æ±‚ |
|------|----------|
| JDK | 21+ |
| Maven | 3.8+ |
| SQL Server | 2022 |
| Spring Boot | 3.5.7 |

### 1.2 æ•°æ®åº“é…ç½®

#### åˆ›å»ºæ•°æ®åº“

```sql
CREATE DATABASE BatchWeaverDB;
CREATE DATABASE DB2_Business;
CREATE DATABASE DB3_Business;
CREATE DATABASE DB4_Business;
```

#### é…ç½®æ–‡ä»¶ä½ç½®

```
src/main/resources/application.yml
```

#### å…³é”®é…ç½®é¡¹

```yaml
spring:
  datasource:
    db1:
      jdbc-url: jdbc:sqlserver://localhost:1433;databaseName=BatchWeaverDB;encrypt=true;trustServerCertificate=true
      username: sa
      password: YourPassword123
    db2:
      jdbc-url: jdbc:sqlserver://localhost:1433;databaseName=DB2_Business;encrypt=true;trustServerCertificate=true
      username: sa
      password: YourPassword123
  batch:
    job:
      enabled: false  # ç¦æ­¢è‡ªåŠ¨å¯åŠ¨ï¼Œé€šè¿‡ JobLauncher æ‰‹åŠ¨è§¦å‘
```

### 1.3 åˆ›å»ºæµ‹è¯•è¡¨

```sql
-- DB2: ç”¨æˆ·è¡¨
USE DB2_Business;
CREATE TABLE DEMO_USER (
    id INT PRIMARY KEY,
    name NVARCHAR(100),
    email NVARCHAR(200),
    birth_date DATE
);

-- DB3/DB4: ç±»ä¼¼ç»“æ„
USE DB3_Business;
CREATE TABLE DEMO_USER (
    id INT PRIMARY KEY,
    name NVARCHAR(100),
    email NVARCHAR(200),
    birth_date DATE
);
```

### 1.4 æµ‹è¯•ä»£ç ç»“æ„

```
src/
â”œâ”€â”€ main/java/com/batchweaver/demo/config/
â”‚   â”œâ”€â”€ ConditionalFlowConfig.java    # Job1 é…ç½®
â”‚   â”œâ”€â”€ ChunkProcessingConfig.java    # Job2 é…ç½®
â”‚   â”œâ”€â”€ FileImportConfig.java         # Job3 é…ç½®
â”‚   â”œâ”€â”€ FileExportConfig.java         # Job4 é…ç½®
â”‚   â””â”€â”€ ComplexWorkflowConfig.java    # Job5 é…ç½®
â””â”€â”€ test/java/com/batchweaver/demo/
    â”œâ”€â”€ AbstractBatchTest.java        # æµ‹è¯•åŸºç±»
    â”œâ”€â”€ Job1ConditionalFlowTest.java  # Job1 æµ‹è¯•
    â”œâ”€â”€ Job2ChunkProcessingTest.java  # Job2 æµ‹è¯•
    â”œâ”€â”€ Job3FileImportTest.java       # Job3 æµ‹è¯•
    â”œâ”€â”€ Job4FileExportTest.java       # Job4 æµ‹è¯•
    â”œâ”€â”€ Job5ComplexWorkflowTest.java  # Job5 æµ‹è¯•
    â””â”€â”€ TransactionIsolationTest.java # äº‹åŠ¡éš”ç¦»æµ‹è¯•
```

---

## 2. æµ‹è¯•æ•°æ®å‡†å¤‡

### 2.1 æµ‹è¯•æ–‡ä»¶ç›®å½•ç»“æ„

```
data/
â”œâ”€â”€ input/
â”‚   â”œâ”€â”€ demo_users.txt           # åŸºç¡€æµ‹è¯•æ–‡ä»¶ (Job1)
â”‚   â”œâ”€â”€ workflow_users.txt       # å·¥ä½œæµæµ‹è¯•æ–‡ä»¶ (Job5)
â”‚   â”œâ”€â”€ large_users.txt          # å¤§æ‰¹é‡æµ‹è¯•æ–‡ä»¶ (Job2)
â”‚   â”œâ”€â”€ format1_users.txt        # æ ¼å¼1: yyyyMMdd + çº¯æ•°å­—
â”‚   â”œâ”€â”€ format2_users.txt        # æ ¼å¼2:MMddyyyy + Rå‰ç¼€
â”‚   â”œâ”€â”€ format3_users.txt        # æ ¼å¼3: æ— å¤´å°¾
â”‚   â””â”€â”€ invalid_users.txt        # å¼‚å¸¸æµ‹è¯•æ–‡ä»¶
â””â”€â”€ output/
    â”œâ”€â”€ format1_export.txt       # æ ¼å¼1å¯¼å‡º
    â”œâ”€â”€ format2_export.txt       # æ ¼å¼2å¯¼å‡º
    â””â”€â”€ result_export.txt        # ç»“æœå¯¼å‡º (Job5)
```

### 2.2 æµ‹è¯•æ–‡ä»¶å†…å®¹

#### demo_users.txt (Job1 åŸºç¡€æ–‡ä»¶)

```
H|20260120|USER_IMPORT
1|å¼ ä¸‰|25|zhangsan@example.com|1990-01-15
2|æå››|30|lisi@example.com|1985-06-20
3|ç‹äº”|28|wangwu@example.com|1987-03-10
T|3
```

#### workflow_users.txt (Job5 å·¥ä½œæµæ–‡ä»¶)

```
20260120
å¼ ä¸‰,25,zhangsan@example.com,1990-01-15
æå››,30,lisi@example.com,1985-06-20
ç‹äº”,28,wangwu@example.com,1987-03-10
3
```

#### format1_users.txt (æ ¼å¼1: yyyyMMdd + çº¯æ•°å­—)

```
20260120
å¼ ä¸‰,25,zhangsan@example.com,1990-01-15
æå››,30,lisi@example.com,1985-06-20
ç‹äº”,28,wangwu@example.com,1987-03-10
3
```

#### format2_users.txt (æ ¼å¼2: MMddyyyy + Rå‰ç¼€)

```
01202026
å¼ ä¸‰,25,zhangsan@example.com,1990-01-15
æå››,30,lisi@example.com,1985-06-20
ç‹äº”,28,wangwu@example.com,1987-03-10
R00003
```

#### format3_users.txt (æ ¼å¼3: æ— å¤´å°¾)

```
å¼ ä¸‰,25,zhangsan@example.com,1990-01-15
æå››,30,lisi@example.com,1985-06-20
ç‹äº”,28,wangwu@example.com,1987-03-10
```

#### invalid_users.txt (å¼‚å¸¸æµ‹è¯•)

```
20260119
å¼ ä¸‰,25,zhangsan@example.com,1990-01-15
æå››,INVALID_EMAIL,lisi@example.com,1985-06-20
ç‹äº”,28,wangwu@example.com,1987-03-10
3
```

---

## 3. Job æµ‹è¯•ç”¨ä¾‹

### Job1: æ¡ä»¶æµç¨‹æµ‹è¯• (Conditional Flow)

#### æµ‹è¯•ç›®çš„
éªŒè¯ Spring Batch çš„æ¡ä»¶åˆ†æ”¯åŠŸèƒ½ï¼Œæ ¹æ®æ•°æ®å¤„ç†ç»“æœæ‰§è¡Œä¸åŒæµç¨‹ã€‚

#### é…ç½®ä¿¡æ¯

| é¡¹ç›® | å€¼ |
|------|-----|
| **é…ç½®ç±»** | `com.batchweaver.demo.config.ConditionalFlowConfig` |
| **Jobåç§°** | `conditionalFlowJob` |
| **æµ‹è¯•ç±»** | `com.batchweaver.demo.Job1ConditionalFlowTest` |
| **æ–‡ä»¶æ ¼å¼** | `H\|yyyyMMdd\|type` + æ•°æ® + `T\|count` |

#### å·¥ä½œæµå›¾

```mermaid
flowchart TB
    subgraph Job1["Job1: Conditional Flow"]
        S1["conditionalImportStep<br/>(å¯¼å…¥æ•°æ®)"]
        D["resultDecider<br/>(å†³ç­–å™¨)"]

        S1 --> D

        D -->|COMPLETED| S2["successStep<br/>(æˆåŠŸæç¤º)"]
        D -->|COMPLETED_WITH_SKIPS| S3["successStep<br/>(å¸¦skipæç¤º)"]
        D -->|FAILED| S4["failureStep<br/>(å¤±è´¥æç¤º)"]

        style S2 fill:#90EE90
        style S3 fill:#FFD700
        style S4 fill:#FFB6C1
    end
```

#### æµ‹è¯•åœºæ™¯

| åœºæ™¯ | æè¿° | é¢„æœŸç»“æœ |
|------|------|----------|
| **æ­£å‘** | æ­£å¸¸æ‰§è¡Œå¯¼å…¥ | âœ… Stepæ‰§è¡Œå®Œæˆï¼ŒçŠ¶æ€COMPLETED<br>âœ… DB2æ’å…¥3æ¡è®°å½•<br>âœ… è¿›å…¥successStep |
| **å¸¦Skip** | æ•°æ®åŒ…å«é”™è¯¯è¡Œï¼ˆå¯ç”¨skipï¼‰ | âœ… è·³è¿‡é”™è¯¯è¡Œï¼Œå®Œæˆå…¶ä»–è®°å½•<br>âš ï¸ è¿›å…¥successStepï¼Œæ—¥å¿—è®°å½•skipæ¬¡æ•° |
| **å¤±è´¥** | æ•°æ®æ ¼å¼ä¸¥é‡é”™è¯¯ | âŒ è¿›å…¥failureStep |

#### æµ‹è¯•æ­¥éª¤

1. **å‡†å¤‡é˜¶æ®µ**
   ```sql
   -- æ¸…ç©ºDB2ä¸šåŠ¡è¡¨
   DELETE FROM DB2_Business.dbo.DEMO_USER;
   ```

2. **æ‰§è¡ŒJob**
   ```bash
   # ä½¿ç”¨ JUnit æµ‹è¯•
   mvn test -Dtest=Job1ConditionalFlowTest
   ```

3. **éªŒè¯ç»“æœ**
   ```sql
   -- éªŒè¯æ•°æ®å¯¼å…¥
   SELECT COUNT(*) FROM DB2_Business.dbo.DEMO_USER;
   -- é¢„æœŸç»“æœ: 3

   -- éªŒè¯å…ƒæ•°æ®
   SELECT JOB_NAME, STATUS, EXIT_CODE
   FROM BatchWeaverDB.dbo.BATCH_JOB_EXECUTION
   WHERE JOB_NAME = 'conditionalFlowJob';
   -- é¢„æœŸç»“æœ: STATUS=COMPLETED, EXIT_CODE=COMPLETED
   ```

#### é¢„æœŸè¾“å‡ºå€¼

| æŒ‡æ ‡ | é¢„æœŸå€¼ |
|------|--------|
| è¯»å–è®°å½•æ•° | 3 |
| å†™å…¥è®°å½•æ•° | 3 |
| è·³è¿‡è®°å½•æ•° | 0 |
| JobçŠ¶æ€ | COMPLETED |
| æ‰§è¡Œæ—¶é—´ | < 5ç§’ |

---

### Job2: æ‰¹å¤„ç†æ¨¡å¼æµ‹è¯• (Chunk-Oriented Processing with Decider Pattern)

#### æµ‹è¯•ç›®çš„
éªŒè¯åŸºäº Chunk çš„æ‰¹å¤„ç†æ¨¡å¼ï¼Œæµ‹è¯• commit-interval å’Œäº‹åŠ¡è¾¹ç•Œï¼Œä»¥åŠä½¿ç”¨ Decider æ¨¡å¼è¿›è¡Œæ¡ä»¶å†³ç­–å’Œæ•°æ®æ¸…ç†æœºåˆ¶ã€‚

#### é…ç½®ä¿¡æ¯

| é¡¹ç›® | å€¼ |
|------|-----|
| **é…ç½®ç±»** | `com.batchweaver.demo.jobs.ChunkProcessingConfig` |
| **Jobåç§°** | `chunkProcessingJob` |
| **æµ‹è¯•ç±»** | `com.batchweaver.demo.Job2ChunkProcessingTest` |
| **æ–‡ä»¶æ ¼å¼** | `yyyyMMdd` + æ•°æ®è¡Œ + `count` |

#### Job å·¥ä½œæµï¼ˆDecider æ¨¡å¼ï¼‰

```mermaid
flowchart TB
    subgraph Job2["Job2: Chunk Processing (Decider Pattern)"]
        S1["chunkProcessingStep<br/>(Chunk æ‰¹å¤„ç†)"]
        D["recordCountDecider<br/>(æ ¡éªŒå†³ç­–å™¨)"]
        S2["cleanupStep<br/>(æ•°æ®æ¸…ç†)"]
        L["cleanupStepListener<br/>(çŠ¶æ€ç›‘å¬å™¨)"]

        S1 --> D

        D -->|VALID| SUCCESS[Job COMPLETED]
        D -->|INVALID| S2
        S2 --> L --> END2[Job FAILED]

        style D fill:#FFD700
        style SUCCESS fill:#90EE90
        style L fill:#FFA500
        style END2 fill:#FFB6C1
    end
```

**ç»„ä»¶è¯´æ˜**ï¼š

1. **chunkProcessingStep**:
   - ä»¥ Chunk æ¨¡å¼è¯»å–æ–‡ä»¶å¹¶å†™å…¥æ•°æ®åº“
   - æ¯ 10 æ¡è®°å½•æäº¤ä¸€æ¬¡äº‹åŠ¡
   - Footer ä¿¡æ¯å­˜å‚¨åˆ° JobExecutionContextï¼Œä¾› Decider ä½¿ç”¨

2. **recordCountDecider** (JobExecutionDecider):
   - ä» JobExecutionContext è·å– Footer å£°æ˜çš„è®°å½•æ•°
   - æŸ¥è¯¢æ•°æ®åº“å®é™…è®°å½•æ•°
   - è¿”å› `VALID`ï¼ˆåŒ¹é…ï¼‰æˆ– `INVALID`ï¼ˆä¸åŒ¹é…ï¼‰

3. **cleanupStep**:
   - ä½¿ç”¨é»˜è®¤ `REQUIRED` äº‹åŠ¡ä¼ æ’­
   - åˆ é™¤æ‰€æœ‰æ•°æ®
   - æ­£å¸¸å®Œæˆï¼Œä¸æŠ›å¼‚å¸¸

4. **cleanupStepListener** (StepExecutionListener):
   - åœ¨ cleanupStep å®Œæˆåå°† Job çŠ¶æ€æ ‡è®°ä¸º `FAILED`
   - è®°å½•å¤±è´¥åŸå› åˆ° JobExecutionContext

**è®¾è®¡ä¼˜åŠ¿**ï¼š

| ä¼˜åŠ¿ | è¯´æ˜ |
|------|------|
| **èŒè´£åˆ†ç¦»** | Decider åªè´Ÿè´£å†³ç­–ï¼ŒcleanupStep åªè´Ÿè´£æ¸…ç†ï¼ŒListener è´Ÿè´£çŠ¶æ€ |
| **äº‹åŠ¡ç®€åŒ–** | cleanupStep ä½¿ç”¨é»˜è®¤ REQUIREDï¼Œä¸æŠ›å¼‚å¸¸ï¼Œæ— éœ€ REQUIRES_NEW |
| **ç¬¦åˆ Spring Batch è®¾è®¡æ¨¡å¼** | ä½¿ç”¨ Decider è€Œéåœ¨ Step ä¸­æ··åˆé€»è¾‘ |
| **æ˜“äºæµ‹è¯•** | Deciderã€cleanupStepã€Listener å¯ä»¥ç‹¬ç«‹æµ‹è¯• |
| **æ˜“äºæ‰©å±•** | æœªæ¥å¯ä»¥æ·»åŠ æ›´å¤šçš„å†³ç­–åˆ†æ”¯ |

#### Chunké…ç½®

```yaml
batch:
  chunk-size: 10  # æ¯10æ¡è®°å½•æäº¤ä¸€æ¬¡
```

#### æµ‹è¯•åœºæ™¯

##### åœºæ™¯1: æ­£å¸¸å¤„ç†ï¼ˆFooter åŒ¹é…ï¼‰

| åœºæ™¯ | æ•°æ®é‡ | Chunkå¤§å° | é¢„æœŸæäº¤æ¬¡æ•° |
|------|--------|-----------|--------------|
| **å°æ‰¹é‡** | 100æ¡ | 10 | 10æ¬¡ |
| **ä¸­æ‰¹é‡** | 1,000æ¡ | 10 | 100æ¬¡ |
| **å¤§æ‰¹é‡** | 10,000æ¡ | 100 | 100æ¬¡ |

**é¢„æœŸç»“æœ**ï¼š
- âœ… chunkProcessingStep: COMPLETED (Read: 100, Written: 100)
- âœ… recordCountDecider: è¿”å› `VALID`
- âœ… JobçŠ¶æ€: COMPLETED
- âœ… æ•°æ®åº“è®°å½•æ•° = Footer å£°æ˜æ•°

**æ—¥å¿—è¾“å‡º**ï¼š
```
[CHUNK] Step completed. Read: 100, Written: 100, Skipped: 0
[DECIDER] Declared count: 100, Actual DB count: 100
[DECIDER] âœ… Validation PASSED
Job: [SimpleJob: [name=chunkProcessingJob]] completed with status: [COMPLETED]
```

##### åœºæ™¯2: Footer æ ¡éªŒå¤±è´¥ï¼ˆæ•°é‡ä¸åŒ¹é…ï¼‰

**å‰ç½®æ¡ä»¶**ï¼š
```
data/input/large_users.txt
- Header: 20260122
- æ•°æ®è¡Œ: 100æ¡
- Footer: 101 (æ•…æ„é”™è¯¯)
```

**é¢„æœŸç»“æœ**ï¼š
- âœ… chunkProcessingStep: COMPLETED (Read: 100, Written: 100)
- âœ… recordCountDecider: è¿”å› `INVALID`
- âœ… cleanupStep: COMPLETED (åˆ é™¤äº†æ‰€æœ‰æ•°æ®)
- âŒ JobçŠ¶æ€: FAILED (ç”± cleanupStepListener è®¾ç½®)
- âœ… æ•°æ®åº“è®°å½•æ•°: 0 (å·²æ¸…ç†)
- âœ… äº‹åŠ¡ç®¡ç†: cleanupStep ä½¿ç”¨é»˜è®¤ REQUIRED äº‹åŠ¡ï¼Œä¸æŠ›å¼‚å¸¸

**æ—¥å¿—è¾“å‡º**ï¼š
```
[CHUNK] Step completed. Read: 100, Written: 100, Skipped: 0

[DECIDER] Declared count: 101, Actual DB count: 100
[DECIDER] âŒ Validation FAILED - mismatch detected
[DECIDER] Will proceed to cleanup step

================================================================================
ğŸ”„ [äº‹åŠ¡å¼€å§‹] ID: 1, åç§°: cleanupStep-cleanup
   ä¼ æ’­è¡Œä¸º: REQUIRED, éš”ç¦»çº§åˆ«: DEFAULT, åªè¯»: false
================================================================================
[CLEANUP] Starting data cleanup...
[CLEANUP] Declared: 101
   ğŸ“ [SQLæ‰§è¡Œ] DELETE FROM DEMO_USER
[CLEANUP] Deleted all rows from DEMO_USER
================================================================================
âœ… [äº‹åŠ¡æäº¤] ID: 1, åç§°: cleanupStep-cleanup, è€—æ—¶: 45ms
================================================================================
[CLEANUP] âœ… Data cleanup completed successfully
[CLEANUP] Cleanup completed: Declared=101, Action=DELETE FROM DEMO_USER
[CLEANUP-LISTENER] Job status set to FAILED

Job: [SimpleJob: [name=chunkProcessingJob]] completed with status: [FAILED]
```

#### æµ‹è¯•æ­¥éª¤

1. **å‡†å¤‡æµ‹è¯•æ–‡ä»¶**
   ```bash
   # ç”Ÿæˆ100æ¡æµ‹è¯•æ•°æ®
   python scripts/generate_test_data.py --count 100 --output data/input/large_users.txt
   ```

2. **æ‰§è¡ŒJobå¹¶ç›‘æ§**
   ```bash
   mvn spring-boot:run -Dspring-boot.run.arguments="--job.name=chunkProcessingJob"
   ```

3. **éªŒè¯äº‹åŠ¡æäº¤**
   ```sql
   -- æ£€æŸ¥æœ€ç»ˆç»“æœ
   SELECT COUNT(*) FROM DB2_Business.dbo.DEMO_USER;
   -- æ­£å¸¸æƒ…å†µ: 100
   -- Footer é”™è¯¯æƒ…å†µ: 0 (å·²å›æ»š)
   ```

#### é¢„æœŸè¾“å‡ºå€¼

| æ•°æ®é‡ | Chunkå¤§å° | é¢„æœŸè€—æ—¶ | å†…å­˜å ç”¨ |
|--------|-----------|----------|----------|
| 100 | 10 | < 5ç§’ | < 50MB |
| 1,000 | 10 | < 10ç§’ | < 50MB |
| 10,000 | 100 | < 30ç§’ | < 100MB |

---

### Job3: æ–‡ä»¶å¯¼å…¥æµ‹è¯• (File Import)

#### æµ‹è¯•ç›®çš„
éªŒè¯ä¸åŒæ ¼å¼çš„æ–‡ä»¶å¯¼å…¥åŠŸèƒ½ï¼ŒåŒ…æ‹¬ Header/Footer æ ¡éªŒã€‚

#### é…ç½®ä¿¡æ¯

| é¡¹ç›® | å€¼ |
|------|-----|
| **é…ç½®ç±»** | `com.batchweaver.demo.config.FileImportConfig` |
| **æµ‹è¯•ç±»** | `com.batchweaver.demo.Job3FileImportTest` |

#### Jobåˆ—è¡¨

| Jobåç§° | æ–‡ä»¶æ ¼å¼ | Header | Footer | è¯´æ˜ |
|---------|----------|--------|--------|------|
| **masterImportJob** | ä¸²è¡Œæ‰§è¡Œæ‰€æœ‰æ ¼å¼ | - | - | ä¾æ¬¡æ‰§è¡Œ format1â†’format2â†’format3 |
| format1ImportJob | yyyyMMdd + çº¯æ•°å­— | `20260120` | `3` | å•ç‹¬æ‰§è¡Œ Format1 |
| format2ImportJob | MMddyyyy + Rå‰ç¼€ | `01202026` | `R00003` | å•ç‹¬æ‰§è¡Œ Format2 |
| format3ImportJob | æ— å¤´å°¾ | æ—  | æ—  | å•ç‹¬æ‰§è¡Œ Format3 |

#### æµ‹è¯•åœºæ™¯

##### åœºæ™¯1: Master Job ä¸²è¡Œå¯¼å…¥ï¼ˆæ¨èï¼‰

**å‰ç½®æ¡ä»¶**
```
data/input/format1_users.txt å­˜åœ¨ä¸”å†…å®¹æ­£ç¡®
data/input/format2_users.txt å­˜åœ¨ä¸”å†…å®¹æ­£ç¡®
data/input/format3_users.txt å­˜åœ¨ä¸”å†…å®¹æ­£ç¡®
```

**æ‰§è¡Œå‘½ä»¤**
```bash
mvn spring-boot:run -Dspring-boot.run.arguments="--job.name=masterImportJob"
```

**é¢„æœŸç»“æœ**
- âœ… JobçŠ¶æ€: COMPLETED
- âœ… format1ImportStep: COMPLETED (è¯»å–3æ¡)
- âœ… format2ImportStep: COMPLETED (è¯»å–3æ¡)
- âœ… format3ImportStep: COMPLETED (è¯»å–3æ¡)
- âœ… DB2æ€»å…±æ’å…¥9æ¡è®°å½•

**é¢„æœŸè¾“å‡ºå€¼**
```
[Format1] Header parsed: 2026-01-20
[Format1] Footer validation passed: expected=3, actual=3
[Format2] Header parsed: 2026-01-20
[Format2] Footer validation passed: expected=3, actual=3
[Format3] Processing 3 records without header/footer
Job: [SimpleJob: [name=masterImportJob]] completed with status: [COMPLETED]
```

**å·¥ä½œæµç¨‹å›¾**
```mermaid
flowchart LR
    Start[å¼€å§‹] --> S1[format1ImportStep]
    S1 --> S2[format2ImportStep]
    S2 --> S3[format3ImportStep]
    S3 --> End[å®Œæˆ]

    S1 -.å¤±è´¥.-> Fail[Job FAILED]
    S2 -.å¤±è´¥.-> Fail
    S3 -.å¤±è´¥.-> Fail
```

##### åœºæ™¯2: æ ¼å¼1æ­£å¸¸å¯¼å…¥

**å‰ç½®æ¡ä»¶**
```
data/input/format1_users.txt å­˜åœ¨ä¸”å†…å®¹æ­£ç¡®
```

**é¢„æœŸç»“æœ**
- âœ… JobçŠ¶æ€: COMPLETED
- âœ… è¯»å–è®°å½•æ•°: 3
- âœ… Headeræ ¡éªŒé€šè¿‡
- âœ… Footeræ ¡éªŒé€šè¿‡ (count=3)
- âœ… DB2æ’å…¥3æ¡è®°å½•

**é¢„æœŸè¾“å‡ºå€¼**
```
[Format1] Header parsed: 2026-01-20
[Format1] Footer validation passed: expected=3, actual=3
```

##### åœºæ™¯3: æ ¼å¼2æ­£å¸¸å¯¼å…¥

**å‰ç½®æ¡ä»¶**
```
data/input/format2_users.txt å­˜åœ¨ä¸”å†…å®¹æ­£ç¡®
```

**é¢„æœŸç»“æœ**
- âœ… JobçŠ¶æ€: COMPLETED
- âœ… è¯»å–è®°å½•æ•°: 3
- âœ… Headerè§£æ: MMddyyyyæ ¼å¼
- âœ… Footerè§£æ: Rå‰ç¼€è¯†åˆ«

##### åœºæ™¯4: æ— å¤´å°¾å¯¼å…¥

**å‰ç½®æ¡ä»¶**
```
data/input/format3_users.txt å­˜åœ¨ä¸”æ— å¤´å°¾
```

**é¢„æœŸç»“æœ**
- âœ… JobçŠ¶æ€: COMPLETED
- âœ… è¯»å–è®°å½•æ•°: 3
- âœ… æ— Header/Footeræ ¡éªŒ

##### åœºæ™¯5: Master Job ä¸­é—´æ­¥éª¤å¤±è´¥ï¼ˆè´Ÿå‘ï¼‰

**å‰ç½®æ¡ä»¶**
```
data/input/format1_users.txt æ­£å¸¸
data/input/format2_users.txt Footer count=5ï¼ˆå®é™…åªæœ‰3æ¡æ•°æ®ï¼‰
data/input/format3_users.txt æ­£å¸¸
```

**æ‰§è¡Œå‘½ä»¤**
```bash
mvn spring-boot:run -Dspring-boot.run.arguments="--job.name=masterImportJob"
```

**é¢„æœŸç»“æœ**
- âœ… format1ImportStep: COMPLETED (è¯»å–3æ¡)
- âŒ format2ImportStep: FAILED (Footer æ ¡éªŒå¤±è´¥)
- â­ï¸ format3ImportStep: SKIPPED (æœªæ‰§è¡Œ)
- âŒ JobçŠ¶æ€: FAILED
- âœ… DB2åªæ’å…¥3æ¡è®°å½•ï¼ˆformat1çš„æ•°æ®ï¼‰

**é¢„æœŸè¾“å‡ºå€¼**
```
[Format1] Footer validation passed: expected=3, actual=3
[Format2] ERROR: Count mismatch - expected: 5, actual: 3
Job: [SimpleJob: [name=masterImportJob]] completed with status: [FAILED]
```

##### åœºæ™¯6: Headeræ—¥æœŸä¸åŒ¹é…ï¼ˆè´Ÿå‘ï¼‰

**å‰ç½®æ¡ä»¶**
```
data/input/format1_users.txt Headeræ—¥æœŸä¸º 20260119ï¼ˆéä»Šå¤©ï¼‰
```

**é¢„æœŸç»“æœ**
- âš ï¸ JobçŠ¶æ€: COMPLETED (å½“å‰å®ç°ä»…æ‰“å°è­¦å‘Š)
- âš ï¸ æ—¥å¿—: "[Format1] Header date mismatch"

##### åœºæ™¯7: Footeræ•°é‡ä¸åŒ¹é…ï¼ˆè´Ÿå‘ï¼‰

**å‰ç½®æ¡ä»¶**
```
data/input/format1_users.txt Footer count=5ï¼ˆå®é™…åªæœ‰3æ¡æ•°æ®ï¼‰
```

**é¢„æœŸç»“æœ**
- âŒ JobçŠ¶æ€: FAILED
- âŒ å¼‚å¸¸: IllegalStateException("[Format1] Count mismatch")

**é¢„æœŸè¾“å‡ºå€¼**
```
ERROR FooterValidator: [Format1] Count mismatch - expected: 5, actual: 3
```

---

### Job4: æ–‡ä»¶å¯¼å‡ºæµ‹è¯• (File Export)

#### æµ‹è¯•ç›®çš„
éªŒè¯æ•°æ®ä»æ•°æ®åº“å¯¼å‡ºåˆ°æ–‡ä»¶çš„åŠŸèƒ½ï¼ŒåŒ…æ‹¬ Header/Footer ç”Ÿæˆã€‚

#### é…ç½®ä¿¡æ¯

| é¡¹ç›® | å€¼ |
|------|-----|
| **é…ç½®ç±»** | `com.batchweaver.demo.config.FileExportConfig` |
| **æµ‹è¯•ç±»** | `com.batchweaver.demo.Job4FileExportTest` |

#### Jobåˆ—è¡¨

| Jobåç§° | è¾“å‡ºæ–‡ä»¶ | Headeræ ¼å¼ | Footeræ ¼å¼ |
|---------|----------|------------|------------|
| format1ExportJob | format1_export.txt | yyyyMMdd | çº¯æ•°å­— |
| format2ExportJob | format2_export.txt | MMddyyyy | Rå‰ç¼€ |

#### æµ‹è¯•åœºæ™¯

##### åœºæ™¯1: æ ¼å¼1å¯¼å‡º

**å‰ç½®æ¡ä»¶**
```sql
-- DB2åŒ…å«æµ‹è¯•æ•°æ®
INSERT INTO DB2_Business.dbo.DEMO_USER VALUES
(1, N'å¼ ä¸‰', 'zhangsan@example.com', '1990-01-15'),
(2, N'æå››', 'lisi@example.com', '1985-06-20'),
(3, N'ç‹äº”', 'wangwu@example.com', '1987-03-10');
```

**é¢„æœŸç»“æœ**
- âœ… JobçŠ¶æ€: COMPLETED
- âœ… ç”Ÿæˆæ–‡ä»¶: data/output/format1_export.txt
- âœ… æ–‡ä»¶å†…å®¹æ ¼å¼æ­£ç¡®

**é¢„æœŸæ–‡ä»¶å†…å®¹**
```
20260120
å¼ ä¸‰,25,zhangsan@example.com,1990-01-15
æå››,30,lisi@example.com,1985-06-20
ç‹äº”,28,wangwu@example.com,1987-03-10
3
```

##### åœºæ™¯2: æ ¼å¼2å¯¼å‡º

**é¢„æœŸæ–‡ä»¶å†…å®¹**
```
01202026
å¼ ä¸‰,25,zhangsan@example.com,1990-01-15
æå››,30,lisi@example.com,1985-06-20
ç‹äº”,28,wangwu@example.com,1987-03-10
R00003
```

##### åœºæ™¯3: ç©ºæ•°æ®å¯¼å‡º

**å‰ç½®æ¡ä»¶**
```sql
DELETE FROM DB2_Business.dbo.DEMO_USER;
```

**é¢„æœŸç»“æœ**
- âœ… JobçŠ¶æ€: COMPLETED
- âœ… æ–‡ä»¶åªåŒ…å« Header + Footer (count=0)

**é¢„æœŸæ–‡ä»¶å†…å®¹**
```
20260120
0
```

##### åœºæ™¯4: å¤§æ•°æ®é‡å¯¼å‡º

**é¢„æœŸè¾“å‡ºå€¼**

| æ•°æ®é‡ | é¢„æœŸè€—æ—¶ | æ–‡ä»¶å¤§å° |
|--------|----------|----------|
| 10,000 | < 5ç§’ | ~2MB |
| 100,000 | < 30ç§’ | ~20MB |

---

### Job5: å¤æ‚å·¥ä½œæµæµ‹è¯• (Complex Workflow)

#### æµ‹è¯•ç›®çš„
éªŒè¯å¤šæ­¥éª¤ã€æ¡ä»¶åˆ†æ”¯ã€é‚®ä»¶é€šçŸ¥çš„å¤æ‚å·¥ä½œæµã€‚

#### é…ç½®ä¿¡æ¯

| é¡¹ç›® | å€¼ |
|------|-----|
| **é…ç½®ç±»** | `com.batchweaver.demo.config.ComplexWorkflowConfig` |
| **Jobåç§°** | `complexWorkflowJob` |
| **æµ‹è¯•ç±»** | `com.batchweaver.demo.Job5ComplexWorkflowTest` |
| **æ–‡ä»¶æ ¼å¼** | `yyyyMMdd` + æ•°æ®è¡Œ + `count` |

#### å·¥ä½œæµæ­¥éª¤

```mermaid
flowchart TB
    subgraph Job5["Job5: Complex Workflow"]
        S1["step1Import<br/>(å¯¼å…¥æ•°æ®åˆ° DB2)"]
        S2["step2SyncToDb3<br/>(DB2 â†’ DB3)"]
        S3["step3SyncToDb4<br/>(DB2 â†’ DB4)"]
        D["decisionStep4<br/>(å†³ç­–å™¨)"]

        S1 --> S2
        S2 --> S3
        S3 --> D

        D -->|FAILED| F["step5FailureMail<br/>(å‘é€å¤±è´¥é‚®ä»¶)"]
        D -->|COMPLETED_WITH_SKIPS| S6["step6SuccessMail<br/>(å‘é€è­¦å‘Šé‚®ä»¶)"]
        D -->|COMPLETED| S6

        S6 --> E["step7Export<br/>(å¯¼å‡ºæ•°æ®)"]

        style F fill:#FFB6C1
        style S6 fill:#90EE90
        style E fill:#87CEEB
    end
```

#### æµ‹è¯•åœºæ™¯

##### åœºæ™¯1: æˆåŠŸæµç¨‹ (COMPLETED)

**å‰ç½®æ¡ä»¶**
```
1. data/input/workflow_users.txt åŒ…å«3æ¡æœ‰æ•ˆæ•°æ®
2. DB2/DB3/DB4 è¡¨å·²æ¸…ç©º
3. é‚®ä»¶æœåŠ¡å·²é…ç½®ï¼ˆä½¿ç”¨ Mockï¼‰
```

**é¢„æœŸç»“æœ**

| Step | çŠ¶æ€ | é¢„æœŸè¡Œä¸º |
|------|------|----------|
| **step1Import** | COMPLETED | ä»æ–‡ä»¶å¯¼å…¥3æ¡è®°å½•åˆ°DB2 |
| **step2SyncToDb3** | COMPLETED | ä»DB2å¤åˆ¶æ•°æ®åˆ°DB3 |
| **step3SyncToDb4** | COMPLETED | ä»DB2å¤åˆ¶æ•°æ®åˆ°DB4 |
| **decisionStep4** | COMPLETED | å†³ç­–æ£€æŸ¥é€šè¿‡ |
| **step5FailureMail** | SKIPPED | ä¸æ‰§è¡Œ |
| **step6SuccessMail** | COMPLETED | âœ… å‘é€æˆåŠŸé‚®ä»¶ |
| **step7Export** | COMPLETED | âœ… å¯¼å‡ºæ•°æ®åˆ° output/result_export.txt |

##### åœºæ™¯2: å¤±è´¥æµç¨‹ (FAILED)

**å‰ç½®æ¡ä»¶**
```
data/input/workflow_users.txt åŒ…å«æ ¼å¼é”™è¯¯æ•°æ®
```

**é¢„æœŸç»“æœ**

| Step | çŠ¶æ€ | é¢„æœŸè¡Œä¸º |
|------|------|----------|
| **step1Import** | FAILED | æ•°æ®æ ¼å¼é”™è¯¯ï¼Œå¯¼å…¥å¤±è´¥ |
| **step2SyncToDb3** | NOT STARTED | Step1å¤±è´¥ï¼Œæœªæ‰§è¡Œ |
| **step3SyncToDb4** | NOT STARTED | Step1å¤±è´¥ï¼Œæœªæ‰§è¡Œ |
| **decisionStep4** | FAILED | å†³ç­–ä¸ºå¤±è´¥ |
| **step5FailureMail** | COMPLETED | âœ… å‘é€å¤±è´¥é‚®ä»¶ |
| **step6SuccessMail** | SKIPPED | ä¸æ‰§è¡Œ |
| **step7Export** | SKIPPED | ä¸æ‰§è¡Œ |

##### åœºæ™¯3: éƒ¨åˆ†æˆåŠŸï¼ˆCOMPLETED_WITH_SKIPSï¼‰

**å‰ç½®æ¡ä»¶**
```
æ•°æ®åŒ…å«å°‘é‡é”™è¯¯è¡Œï¼ˆskipLimit=100ï¼‰ï¼Œå¤§éƒ¨åˆ†æ•°æ®æœ‰æ•ˆ
```

**é¢„æœŸç»“æœ**

| Step | çŠ¶æ€ | é¢„æœŸè¡Œä¸º |
|------|------|----------|
| **step1Import** | COMPLETED with skips | è·³è¿‡é”™è¯¯è¡Œï¼Œå®Œæˆå…¶ä»– |
| **step2SyncToDb3** | COMPLETED | å¤„ç†å‰©ä½™æ•°æ® |
| **step3SyncToDb4** | COMPLETED | å¤„ç†å‰©ä½™æ•°æ® |
| **decisionStep4** | COMPLETED_WITH_SKIPS | æ£€æŸ¥è·³è¿‡æ—¥å¿— |
| **step5FailureMail** | SKIPPED | ä¸æ‰§è¡Œ |
| **step6SuccessMail** | COMPLETED | âœ… å‘é€è­¦å‘Šé‚®ä»¶ï¼ˆéƒ¨åˆ†æˆåŠŸï¼‰ |
| **step7Export** | COMPLETED | å¯¼å‡ºæœ‰æ•ˆæ•°æ® |

---

## 4. å‘½ä»¤è¡Œæ‰§è¡Œæ–¹å¼

### 4.1 JobLauncherRunner

BatchWeaver æä¾›äº† `JobLauncherRunner` ç»„ä»¶ï¼Œæ”¯æŒé€šè¿‡å‘½ä»¤è¡Œå‚æ•°è§¦å‘ Job å’Œæ–­ç‚¹ç»­ä¼ ã€‚

#### é…ç½®ä¿¡æ¯

| é¡¹ç›® | å€¼ |
|------|-----|
| **ç±»** | `com.batchweaver.core.scheduler.JobLauncherRunner` |
| **æ¥å£** | `ApplicationRunner` |
| **Profile** | `!test` ï¼ˆæµ‹è¯•ç¯å¢ƒä¸å¯ç”¨ï¼‰ |

#### ä½¿ç”¨æ–¹å¼

```bash
# æ‰§è¡ŒæŒ‡å®š Job
java -jar batchweaver.jar --job.name=<jobName>

# æ‰§è¡Œ Job å¹¶ä¼ é€’ä¸šåŠ¡å‚æ•°
java -jar batchweaver.jar --job.name=<jobName> --data=20250625 --input.file=data/input/users.txt

# æ–­ç‚¹ç»­ä¼ ï¼ˆé‡å¯å¤±è´¥çš„ Jobï¼‰
java -jar batchweaver.jar --job.name=<jobName> --job.id=<executionId>
```

#### å‚æ•°è¯´æ˜

| å‚æ•° | å¿…å¡« | è¯´æ˜ |
|------|------|------|
| `--job.name` | âœ… | Job åç§° |
| `--job.id` | âŒ | Job æ‰§è¡Œ IDï¼ˆç”¨äºæ–­ç‚¹ç»­ä¼ ï¼‰ |
| å…¶ä»–å‚æ•° | âŒ | ä½œä¸º JobParameters ä¼ é€’ç»™ Job |

#### å¯ç”¨çš„ Job åˆ—è¡¨

| Job åç§° | æè¿° |
|----------|------|
| `conditionalFlowJob` | Job1: æ¡ä»¶æµç¨‹æµ‹è¯• |
| `chunkProcessingJob` | Job2: æ‰¹å¤„ç†æ¨¡å¼æµ‹è¯• |
| `format1ImportJob` | Job3: æ ¼å¼1æ–‡ä»¶å¯¼å…¥ |
| `format2ImportJob` | Job3: æ ¼å¼2æ–‡ä»¶å¯¼å…¥ |
| `format3ImportJob` | Job3: æ ¼å¼3æ–‡ä»¶å¯¼å…¥ |
| `format1ExportJob` | Job4: æ ¼å¼1æ–‡ä»¶å¯¼å‡º |
| `format2ExportJob` | Job4: æ ¼å¼2æ–‡ä»¶å¯¼å‡º |
| `complexWorkflowJob` | Job5: å¤æ‚å·¥ä½œæµæµ‹è¯• |

#### æ–­ç‚¹ç»­ä¼ æœºåˆ¶

- ä½¿ç”¨ `JobOperator.restart()` é‡å¯æŒ‡å®šçš„ Job å®ä¾‹
- åªæœ‰çŠ¶æ€ä¸º `FAILED` æˆ– `STOPPED` çš„ Job æ‰èƒ½é‡å¯
- Spring Batch ä¼šä½¿ç”¨åŸ JobParametersï¼Œä»ä¸Šæ¬¡å¤±è´¥çš„ checkpoint ç»§ç»­
- æ–­ç‚¹ç»­ä¼ æ—¶ä¸å…è®¸ä¼ å…¥æ–°å‚æ•°ï¼ˆéœ€è¦æ–°å‚æ•°åº”å¯åŠ¨æ–° Job å®ä¾‹ï¼‰

#### Job å†…éƒ¨è·å–å‚æ•°

```java
// æ–¹å¼1: @Value æ³¨å…¥ï¼ˆæ¨èï¼‰
@Value("#{jobParameters['data']}")
private String dataDate;

// æ–¹å¼2: ChunkContext è·å–
JobParameters params = chunkContext.getStepContext().getStepExecution()
    .getJobExecution().getJobParameters();
String dataDate = params.getString("data");
```

#### ä½¿ç”¨ç¤ºä¾‹

```bash
# æ‰§è¡Œ Job1
java -jar target/batchweaver.jar --job.name=conditionalFlowJob

# æ‰§è¡Œ Job2 å¹¶ä¼ é€’ä¸šåŠ¡å‚æ•°
java -jar target/batchweaver.jar --job.name=chunkProcessingJob --data=20250625

# æ‰§è¡Œ Job3 æ ¼å¼1å¯¼å…¥ï¼ŒæŒ‡å®šè‡ªå®šä¹‰æ–‡ä»¶
java -jar target/batchweaver.jar --job.name=format1ImportJob --input.file=data/input/users.txt

# æ–­ç‚¹ç»­ä¼ ï¼ˆå‡è®¾ Job ID æ˜¯ 123ï¼‰
java -jar target/batchweaver.jar --job.name=conditionalFlowJob --job.id=123
```

---

### 4.2 å¯åŠ¨ Banner å’Œå…ƒæ•°æ®éªŒè¯

#### Banner æ˜¾ç¤º

åº”ç”¨å¯åŠ¨æ—¶ä¼šæ˜¾ç¤º BatchWeaver ASCII Bannerï¼š

```
================================================================================

   ____       _                   _        ____  __  __           _
  |  _ \ ___ | | _____  _ __     / \      / ___||  \/  | ___   __| |
  | |_) / _ \| |/ / _ \| '_ \   / _ \    \___ \| |\/| |/ _ \ / _` |
  |  _ < (_) |   < (_) | | | | / ___ \    ___) || |  | | (_) | (_| |
  |_| \_\___/|_|\_\___/|_| |_|/_/   \_\  |____/ |_|  |_|\___/ \__,_|

  Spring Batch 5.x Multi-Datasource Job Execution Framework

  Version: 1.0.0
  Author: BatchWeaver Team

================================================================================
```

#### å…ƒæ•°æ®è¡¨éªŒè¯

å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨æ£€æŸ¥ Spring Batch å…ƒæ•°æ®è¡¨æ˜¯å¦å­˜åœ¨ï¼š

| å…ƒæ•°æ®è¡¨ | è¯´æ˜ |
|----------|------|
| `BATCH_JOB_INSTANCE` | Job å®ä¾‹è¡¨ |
| `BATCH_JOB_EXECUTION` | Job æ‰§è¡Œè¡¨ |
| `BATCH_JOB_EXECUTION_PARAMS` | Job å‚æ•°è¡¨ |
| `BATCH_STEP_EXECUTION` | Step æ‰§è¡Œè¡¨ |
| `BATCH_STEP_EXECUTION_CONTEXT` | Step æ‰§è¡Œä¸Šä¸‹æ–‡è¡¨ |
| `BATCH_JOB_EXECUTION_CONTEXT` | Job æ‰§è¡Œä¸Šä¸‹æ–‡è¡¨ |

å¦‚æœè¡¨ä¸å­˜åœ¨ï¼Œä¼šæŠ¥é”™å¹¶æç¤ºè§£å†³æ–¹æ¡ˆï¼š

```
ERROR: Spring Batch metadata tables are missing!
Missing tables:
  - BATCH_JOB_INSTANCE
  - BATCH_STEP_EXECUTION
  ...

Please create Spring Batch metadata tables first.
Or execute: java -jar batchweaver.jar --spring.batch.jdbc.initialize-schema=always
```

---

### 4.3 é…ç½®æ–‡ä»¶åŠ å¯†è§£å¯†

#### åŠ å¯†æ ¼å¼

æ”¯æŒ SM4 åŠ å¯†æ ¼å¼ï¼Œç”¨äºä¿æŠ¤é…ç½®æ–‡ä»¶ä¸­çš„æ•æ„Ÿä¿¡æ¯ï¼š

```yaml
spring:
  datasource:
    password: SM4(encrypted_password_here)
```

#### å·¥ä½œåŸç†

1. `DecryptEnvironmentPostProcessor` åœ¨ Spring Boot å¯åŠ¨å‰æ‰§è¡Œ
2. è‡ªåŠ¨æ£€æµ‹ `SM4(encrypted_value)` æ ¼å¼çš„é…ç½®
3. æå–ä¸­é—´çš„åŠ å¯†å€¼å¹¶è°ƒç”¨è§£å¯†æ–¹æ³•
4. å°†è§£å¯†åçš„å€¼æ³¨å…¥åˆ° Environment

#### è§£å¯†æ–¹æ³•å®ç°

è§£å¯†æ–¹æ³•é¢„ç•™ TODOï¼Œåœ¨ `DecryptEnvironmentPostProcessor.java` ä¸­å®ç°ï¼š

```java
private String decrypt(String encryptedValue) {
    // TODO: å®ç° SM4 è§£å¯†
    // return SM4Util.decrypt(encryptedValue);
}
```

---

## 5. äº‹åŠ¡éš”ç¦»æµ‹è¯•

### æµ‹è¯•ç›®çš„
éªŒè¯å…ƒæ•°æ®äº‹åŠ¡ï¼ˆtm1ï¼‰ä¸ä¸šåŠ¡äº‹åŠ¡ï¼ˆtm2/tm3/tm4ï¼‰çš„éš”ç¦»æ€§ã€‚

### é…ç½®ä¿¡æ¯

| é¡¹ç›® | å€¼ |
|------|-----|
| **æµ‹è¯•ç±»** | `com.batchweaver.demo.TransactionIsolationTest` |

### æµ‹è¯•åœºæ™¯

| åœºæ™¯ | æè¿° | éªŒè¯ç‚¹ |
|------|------|--------|
| **ä¸šåŠ¡äº‹åŠ¡å›æ»š** | Stepæ‰§è¡Œå¤±è´¥ï¼Œä¸šåŠ¡æ•°æ®å›æ»š | âœ… å…ƒæ•°æ®è¡¨æœ‰FAILEDè®°å½•<br>âœ… ä¸šåŠ¡è¡¨ä¸ºç©ºï¼ˆå›æ»šï¼‰ |
| **å…ƒæ•°æ®äº‹åŠ¡æäº¤** | Stepå¤±è´¥ï¼Œå…ƒæ•°æ®æ­£å¸¸æäº¤ | âœ… BATCH_JOB_EXECUTIONæœ‰è®°å½• |

### é¢„æœŸç»“æœ

| éªŒè¯é¡¹ | é¢„æœŸå€¼ |
|--------|--------|
| ä¸šåŠ¡è¡¨è®°å½•æ•° | 0 |
| å…ƒæ•°æ®çŠ¶æ€ | FAILED |
| EXIT_CODE | FAILED |
| EXIT_MESSAGE | åŒ…å«å¼‚å¸¸å †æ ˆ |

---

## 6. æµ‹è¯•æ‰§è¡Œå‘½ä»¤

### 6.1 å‘½ä»¤è¡Œæ‰§è¡Œæ–¹å¼ï¼ˆæ–°å¢ï¼‰

```bash
# æ‰§è¡Œ Job1
java -jar target/batchweaver.jar --job.name=conditionalFlowJob

# æ‰§è¡Œ Job2 å¹¶ä¼ é€’ä¸šåŠ¡å‚æ•°
java -jar target/batchweaver.jar --job.name=chunkProcessingJob --data=20250625

# æ–­ç‚¹ç»­ä¼ 
java -jar target/batchweaver.jar --job.name=conditionalFlowJob --job.id=123
```

### 6.2 JUnit æµ‹è¯•æ–¹å¼

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
mvn clean test
```

### 6.3 è¿è¡Œç‰¹å®š Job æµ‹è¯•

```bash
# Job1: æ¡ä»¶æµç¨‹æµ‹è¯•
mvn test -Dtest=Job1ConditionalFlowTest

# Job2: æ‰¹å¤„ç†æ¨¡å¼æµ‹è¯•
mvn test -Dtest=Job2ChunkProcessingTest

# Job3: æ–‡ä»¶å¯¼å…¥æµ‹è¯•
mvn test -Dtest=Job3FileImportTest

# Job4: æ–‡ä»¶å¯¼å‡ºæµ‹è¯•
mvn test -Dtest=Job4FileExportTest

# Job5: å¤æ‚å·¥ä½œæµæµ‹è¯•
mvn test -Dtest=Job5ComplexWorkflowTest
```

### 6.4 è¿è¡Œé›†æˆæµ‹è¯•

```bash
# äº‹åŠ¡éš”ç¦»æµ‹è¯•
mvn test -Dtest=TransactionIsolationTest
```

### 6.5 ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š

```bash
mvn clean test jacoco:report

# æŸ¥çœ‹æŠ¥å‘Š
open target/site/jacoco/index.html
```

---

## 7. æ•…éšœæ’æŸ¥æŒ‡å—

### 7.1 å¸¸è§é—®é¢˜

| é—®é¢˜ | å¯èƒ½åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|----------|----------|
| Jobæœªå¯åŠ¨ | `spring.batch.job.enabled=false` | ä½¿ç”¨ JobLauncher æ‰‹åŠ¨è§¦å‘ |
| æ‰¾ä¸åˆ°æ–‡ä»¶ | è·¯å¾„é”™è¯¯æˆ–æ–‡ä»¶ä¸å­˜åœ¨ | æ£€æŸ¥ `data/input/` ç›®å½• |
| Headeræ ¡éªŒå¤±è´¥ | æ—¥æœŸæ ¼å¼ä¸åŒ¹é… | è°ƒæ•´ HeaderValidator é€»è¾‘ |
| Footeræ ¡éªŒå¤±è´¥ | æ•°é‡ä¸åŒ¹é… | æ£€æŸ¥æ•°æ®å®Œæ•´æ€§ |
| äº‹åŠ¡å›æ»š | æ•°æ®åº“è¿æ¥é—®é¢˜ | æ£€æŸ¥ `application.yml` é…ç½® |
| å…ƒæ•°æ®è¡¨ç¼ºå¤± | æœªåˆ›å»º Spring Batch è¡¨ | ä½¿ç”¨ `--spring.batch.jdbc.initialize-schema=always` |
| Job æ‰¾ä¸åˆ° | Job åç§°æ‹¼å†™é”™è¯¯ | ä½¿ç”¨ `--job.name` å‚æ•°æŸ¥çœ‹å¯ç”¨ Job åˆ—è¡¨ |

### 7.2 æ—¥å¿—åˆ†æ

**å¯ç”¨DEBUGæ—¥å¿—**

```yaml
logging:
  level:
    org.springframework.batch: DEBUG
    com.batchweaver: DEBUG
    org.springframework.jdbc.core: DEBUG
```

**å…³é”®æ—¥å¿—å…³é”®è¯**

- `JobExecution` - Jobæ‰§è¡ŒçŠ¶æ€
- `StepExecution` - Stepæ‰§è¡ŒçŠ¶æ€
- `Header parsed` - Headerè§£ææˆåŠŸ
- `Footer validation` - Footeræ ¡éªŒç»“æœ
- `Skipped` - è·³è¿‡è®°å½•æ•°
- `Rollback` - äº‹åŠ¡å›æ»š

---

## 8. æµ‹è¯•æ¸…å•

### Job1: æ¡ä»¶æµç¨‹æµ‹è¯•

- [ ] æ­£å¸¸æ‰§è¡ŒæˆåŠŸ
- [ ] æ–‡ä»¶ä¸å­˜åœ¨å¤„ç†
- [ ] æ•°æ®æ ¼å¼é”™è¯¯skip
- [ ] æ•°æ®åº“è¿æ¥å¤±è´¥å¤„ç†
- [ ] å…ƒæ•°æ®æ­£ç¡®è®°å½•

### Job2: æ‰¹å¤„ç†æ¨¡å¼æµ‹è¯•

- [ ] å°æ‰¹é‡æµ‹è¯•ï¼ˆ< 1000æ¡ï¼‰
- [ ] ä¸­æ‰¹é‡æµ‹è¯•ï¼ˆ1000-10000æ¡ï¼‰
- [ ] å¤§æ‰¹é‡æµ‹è¯•ï¼ˆ> 10000æ¡ï¼‰
- [ ] Chunkæäº¤æ¬¡æ•°éªŒè¯
- [ ] äº‹åŠ¡è¾¹ç•ŒéªŒè¯

### Job3: æ–‡ä»¶å¯¼å…¥æµ‹è¯•

- [ ] æ ¼å¼1å¯¼å…¥æˆåŠŸ
- [ ] æ ¼å¼2å¯¼å…¥æˆåŠŸ
- [ ] æ ¼å¼3å¯¼å…¥æˆåŠŸ
- [ ] Headeræ—¥æœŸä¸åŒ¹é…å¤±è´¥
- [ ] Footeræ•°é‡ä¸åŒ¹é…å¤±è´¥
- [ ] ç©ºæ–‡ä»¶å¤„ç†
- [ ] å•è¡Œæ–‡ä»¶å¤„ç†

### Job4: æ–‡ä»¶å¯¼å‡ºæµ‹è¯•

- [ ] æ ¼å¼1å¯¼å‡ºæˆåŠŸ
- [ ] æ ¼å¼2å¯¼å‡ºæˆåŠŸ
- [ ] ç©ºæ•°æ®å¯¼å‡º
- [ ] å¤§æ•°æ®é‡å¯¼å‡º
- [ ] æ–‡ä»¶æ ¼å¼éªŒè¯

### Job5: å¤æ‚å·¥ä½œæµæµ‹è¯•

- [ ] æˆåŠŸæµç¨‹ï¼ˆStep1â†’2â†’3â†’6â†’7ï¼‰
- [ ] å¤±è´¥æµç¨‹ï¼ˆStep1â†’4ï¼‰
- [ ] éƒ¨åˆ†æˆåŠŸæµç¨‹ï¼ˆSkipæœºåˆ¶ï¼‰
- [ ] é‚®ä»¶é€šçŸ¥éªŒè¯
- [ ] Stepè·³è¿‡é€»è¾‘éªŒè¯

### äº‹åŠ¡éš”ç¦»æµ‹è¯•

- [ ] ä¸šåŠ¡äº‹åŠ¡å›æ»šéªŒè¯
- [ ] å…ƒæ•°æ®äº‹åŠ¡æäº¤éªŒè¯
- [ ] å¤šæ•°æ®æºéš”ç¦»éªŒè¯

---

## 9. é™„å½•

### 9.1 æµ‹è¯•æ•°æ®ç”Ÿæˆè„šæœ¬

```python
# scripts/generate_test_data.py
import argparse

def generate_test_data(count, output_file):
    with open(output_file, 'w', encoding='utf-8') as f:
        # Header
        f.write("20260120\n")
        # Data
        for i in range(count):
            f.write(f"User{i},25,user{i}@example.com,1990-01-15\n")
        # Footer
        f.write(f"{count}\n")

if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument("--count", type=int, required=True)
    parser.add_argument("--output", type=str, required=True)
    args = parser.parse_args()
    generate_test_data(args.count, args.output)
```

### 9.2 Mocké‚®ä»¶é…ç½®

```yaml
# application-test.yml
spring:
  mail:
    host: localhost
    port: 2525  # ä½¿ç”¨ Mock Mail Server
    test-connection: false
```

### 9.3 æµ‹è¯•ç»“æœæ¨¡æ¿

```
æµ‹è¯•æ—¥æœŸ: _____________
æµ‹è¯•äººå‘˜: _____________
æµ‹è¯•ç¯å¢ƒ: _____________

Job1: æ¡ä»¶æµç¨‹æµ‹è¯•     [ ] é€šè¿‡  [ ] å¤±è´¥  å¤‡æ³¨: _______
Job2: æ‰¹å¤„ç†æ¨¡å¼æµ‹è¯•   [ ] é€šè¿‡  [ ] å¤±è´¥  å¤‡æ³¨: _______
Job3: æ–‡ä»¶å¯¼å…¥æµ‹è¯•     [ ] é€šè¿‡  [ ] å¤±è´¥  å¤‡æ³¨: _______
Job4: æ–‡ä»¶å¯¼å‡ºæµ‹è¯•     [ ] é€šè¿‡  [ ] å¤±è´¥  å¤‡æ³¨: _______
Job5: å¤æ‚å·¥ä½œæµæµ‹è¯•   [ ] é€šè¿‡  [ ] å¤±è´¥  å¤‡æ³¨: _______
äº‹åŠ¡éš”ç¦»æµ‹è¯•           [ ] é€šè¿‡  [ ] å¤±è´¥  å¤‡æ³¨: _______

æ€»ä½“è¯„ä»·: _____________
ç­¾å­—: _____________
```

---

**æ–‡æ¡£ç»“æŸ**
