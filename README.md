# BatchWeaver - Spring Batch 5.x å¤šæ•°æ®æºæ‰¹å¤„ç†ç³»ç»Ÿ

åŸºäº Spring Batch 5.x çš„ä¼ä¸šçº§æ‰¹å¤„ç†ç³»ç»Ÿï¼Œæ”¯æŒå¤šæ•°æ®æºã€äº‹åŠ¡éš”ç¦»ã€**å•æ¬¡æ‰«æå¤§æ–‡ä»¶å¤„ç†**ã€åŸºäºæ³¨è§£çš„æ–‡ä»¶å¤„ç†æ¡†æ¶ã€‚

## æ ¸å¿ƒç‰¹æ€§

### 1. å•æ¬¡æ‰«æ + å»¶è¿Ÿå†³ç­–æ¶æ„ ğŸš€

**è®¾è®¡åˆ›æ–°**ï¼š
- **é›¶å¯åŠ¨å»¶è¿Ÿ** - ä¸éœ€è¦åœ¨ `open()` æ—¶é¢„å…ˆæ‰«ææ•´ä¸ªæ–‡ä»¶
- **O(1) å†…å­˜å ç”¨** - åªç¼“å­˜ä¸¤è¡Œæ•°æ®ï¼ˆ`prevLine` + `currentLine`ï¼‰
- **å•æ¬¡é¡ºåºæ‰«æ** - æ–‡ä»¶åªè¢«è¯»å–ä¸€æ¬¡ï¼Œå®Œå…¨éµå¾ªæ“ä½œç³»ç»Ÿé¢„è¯»æœºåˆ¶
- **Reader è‡ªåŒ…å«æ ¡éªŒ** - å¤´å°¾æ ¡éªŒé€»è¾‘å†…ç½®åœ¨ Reader ä¸­ï¼Œæ— éœ€é¢å¤– Listener

**é€‚ç”¨åœºæ™¯**ï¼š
- GB çº§å¤§æ–‡ä»¶å¤„ç†
- æµå¼æ•°æ®å¯¼å…¥
- é‡‘èå¯¹è´¦ã€æ—¥å¿—å¯¼å…¥ç­‰æ‰¹å¤„ç†åœºæ™¯

ğŸ“– **æŠ€æœ¯åŸç†**ï¼šå‚è§ [docs/æ–‡ä»¶è¯»å†™.md](docs/æ–‡ä»¶è¯»å†™.md)

### 2. å…ƒæ•°æ®ä¸ä¸šåŠ¡äº‹åŠ¡éš”ç¦»

**è®¾è®¡åŸåˆ™**ï¼š
- **å…ƒæ•°æ®äº‹åŠ¡ï¼ˆtm1Metaï¼‰**ï¼šç»å¯¹ä¸å—ä¸šåŠ¡äº‹åŠ¡å½±å“ï¼Œå¿…é¡»æäº¤æˆåŠŸ
- **ä¸šåŠ¡äº‹åŠ¡ï¼ˆtm1/tm2/tm3/tm4ï¼‰**ï¼šå¤±è´¥æ—¶å¯ä»¥å›æ»š
- **éš”ç¦»ä¿è¯**ï¼šStep å¤±è´¥æ—¶ï¼Œä¸šåŠ¡æ•°æ®å›æ»šï¼Œå…ƒæ•°æ®è®°å½• FAILED çŠ¶æ€

**å¤±è´¥åœºæ™¯æµç¨‹**ï¼š
```
Step æ‰§è¡Œå¤±è´¥æ—¶ï¼š
â”œâ”€â”€ âŒ ä¸šåŠ¡äº‹åŠ¡ï¼ˆtm2ï¼‰å›æ»š â†’ ä¸šåŠ¡æ•°æ®ä¸è½åº“
â””â”€â”€ âœ… å…ƒæ•°æ®äº‹åŠ¡ï¼ˆtm1Metaï¼‰æäº¤ â†’ è®°å½• FAILED çŠ¶æ€ï¼Œæ”¯æŒæ–­ç‚¹ç»­ä¼ 
```

ğŸ“– **é…ç½®è¯¦æƒ…**ï¼šå‚è§ [docs/å¤šæ•°æ®æº.md](docs/å¤šæ•°æ®æº.md)

### 3. å¤šæ•°æ®æºé…ç½®

| æ•°æ®æº | ç”¨é€” | äº‹åŠ¡ç®¡ç†å™¨ |
|--------|------|-----------|
| db1 | Spring Batch å…ƒæ•°æ® + ä¸šåŠ¡æ•°æ® | tm1Metaï¼ˆå…ƒæ•°æ®ï¼‰/ tm1ï¼ˆä¸šåŠ¡ï¼‰ |
| db2 | ä¸šåŠ¡æ•°æ®åº“ 2 | tm2 |
| db3 | ä¸šåŠ¡æ•°æ®åº“ 3 | tm3 |
| db4 | ä¸šåŠ¡æ•°æ®åº“ 4 | tm4 |

### 4. åŸºäºæ³¨è§£çš„æ–‡ä»¶å¤„ç†æ¡†æ¶

```java
@FileColumn(index = 0, name = "userId")
private Integer id;

@FileColumn(index = 1, trim = true, toUpperCase = true)
private String name;

@FileColumn(index = 2, defaultValue = "unknown@example.com")
private String email;
```

æ”¯æŒï¼š
- è‡ªåŠ¨å­—æ®µæ˜ å°„
- æ•°æ®æ¸…æ´—ï¼ˆtrimã€å¤§å°å†™è½¬æ¢ã€é»˜è®¤å€¼ï¼‰
- é¦–å°¾è¡Œæ ¡éªŒ
- ç±»å‹è½¬æ¢ï¼ˆString â†’ Integer/Date/BigDecimalï¼‰
- CSV æ³¨å…¥é˜²æŠ¤
- è·¯å¾„å®‰å…¨æ ¡éªŒ

ğŸ“– **æ¡†æ¶è¯¦æƒ…**ï¼šå‚è§ [docs/æŠ€æœ¯æ¡†æ¶.md](docs/æŠ€æœ¯æ¡†æ¶.md)

---

## ğŸ“‚ é¡¹ç›®ç»“æ„

```
batch-weaver/
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ input/                   # ç¤ºä¾‹è¾“å…¥æ–‡ä»¶
â”‚   â””â”€â”€ output/                  # å¯¼å‡ºæ–‡ä»¶è¾“å‡ºç›®å½•
â”œâ”€â”€ docs/                        # æ–‡æ¡£ç›®å½•
â”‚   â”œâ”€â”€ å¿«é€Ÿå¼€å§‹.md
â”‚   â”œâ”€â”€ æŠ€æœ¯æ¡†æ¶.md
â”‚   â”œâ”€â”€ å¤šæ•°æ®æº.md
â”‚   â”œâ”€â”€ æ–‡ä»¶è¯»å†™.md
â”‚   â”œâ”€â”€ å…ƒæ•°æ®è¡¨.md
â”‚   â””â”€â”€ æµ‹è¯•æ–‡æ¡£.md
â”œâ”€â”€ script/
â”‚   â””â”€â”€ init.sql                 # Spring Batch å…ƒæ•°æ®è¡¨åˆå§‹åŒ–è„šæœ¬
â”œâ”€â”€ src/main/java/com/batchweaver/
â”‚   â”œâ”€â”€ BatchWeaverApplication.java
â”‚   â”œâ”€â”€ core/                    # æ¡†æ¶æ ¸å¿ƒï¼ˆå¤šæ•°æ®æºã€å•æ¬¡æ‰«æã€å·¥å‚æ¨¡å¼ç­‰ï¼‰
â”‚   â”‚   â”œâ”€â”€ annotation/          # @FileColumn æ³¨è§£
â”‚   â”‚   â”œâ”€â”€ config/              # Batch åŸºç¡€è®¾æ–½ + æ•°æ®æºé…ç½®
â”‚   â”‚   â”‚   â””â”€â”€ datasource/      # dataSource1~4 + tm1~4
â”‚   â”‚   â”œâ”€â”€ converter/           # ç±»å‹è½¬æ¢å™¨
â”‚   â”‚   â”œâ”€â”€ factory/             # â­ å·¥å‚æ¨¡å¼ï¼ˆReader/Writer åˆ›å»ºï¼‰
â”‚   â”‚   â”œâ”€â”€ fileprocess/         # å•æ¬¡æ‰«æï¼štemplate/reader/writer/listener ç­‰
â”‚   â”‚   â”œâ”€â”€ processor/           # æ•°æ®æ¸…æ´—å¤„ç†å™¨
â”‚   â”‚   â”œâ”€â”€ reader/              # æ³¨è§£é©±åŠ¨å­—æ®µæ˜ å°„
â”‚   â”‚   â”œâ”€â”€ scheduler/           # Job å¯åŠ¨/è°ƒåº¦å…¥å£
â”‚   â”‚   â”œâ”€â”€ util/                # CSV æ³¨å…¥é˜²æŠ¤ã€è·¯å¾„æ ¡éªŒ
â”‚   â”‚   â””â”€â”€ validator/           # é¦–å°¾è¡Œæ ¡éªŒ
â”‚   â””â”€â”€ demo/                    # ç¤ºä¾‹ä½œä¸šï¼ˆchunk/workflow/export/import ç­‰ï¼‰
â”‚       â”œâ”€â”€ config/
â”‚       â”‚   â”œâ”€â”€ components/      # â­ å…±äº«ç»„ä»¶ï¼ˆListeners/Processors/Writersï¼‰
â”‚       â”‚   â””â”€â”€ jobs/            # â­ ä½œä¸šé…ç½®ï¼ˆæŒ‰åŠŸèƒ½åˆ†ç±»ï¼‰
â”‚       â””â”€â”€ shared/
â”‚           â”œâ”€â”€ config/          # å…±äº«é…ç½®ï¼ˆReader ç­‰ï¼‰
â”‚           â”œâ”€â”€ entity/          # å®ä½“ç±»
â”‚           â””â”€â”€ service/         # ä¸šåŠ¡æœåŠ¡ï¼ˆæ¥å£ï¼‰
â”‚               â””â”€â”€ impl/        # â­ ä¸šåŠ¡æœåŠ¡å®ç°
â”œâ”€â”€ src/main/resources/
â”‚   â”œâ”€â”€ META-INF/spring.factories
â”‚   â”œâ”€â”€ application.yml.example
â”‚   â”œâ”€â”€ log4j2-spring.xml
â”‚   â”œâ”€â”€ schema-db1.sql
â”‚   â””â”€â”€ schema-db2.sql
â”œâ”€â”€ run-all-jobs.bat             # Windows æ‰¹å¤„ç†è„šæœ¬
â”œâ”€â”€ run-all-jobs.ps1             # PowerShell è„šæœ¬ï¼ˆæ¨èï¼‰
â”œâ”€â”€ run-all-jobs-maven.ps1       # Maven æ‰§è¡Œè„šæœ¬
â”œâ”€â”€ pom.xml
â””â”€â”€ README.md
```

---

## ğŸ“– æ–‡æ¡£å¯¼èˆª

| æ–‡æ¡£ | è¯´æ˜ |
|------|------|
| [å¿«é€Ÿå¼€å§‹.md](docs/å¿«é€Ÿå¼€å§‹.md) | 5åˆ†é’Ÿå¿«é€Ÿä½“éªŒï¼Œç¯å¢ƒé…ç½®ä¸åŸºç¡€ç”¨æ³• |
| [æŠ€æœ¯æ¡†æ¶.md](docs/æŠ€æœ¯æ¡†æ¶.md) | æ¡†æ¶æ¶æ„ã€è®¾è®¡æ¨¡å¼ã€æ ¸å¿ƒç»„ä»¶ |
| [å¤šæ•°æ®æº.md](docs/å¤šæ•°æ®æº.md) | å¤šæ•°æ®æºé…ç½®ã€äº‹åŠ¡éš”ç¦»æœºåˆ¶ |
| [æ–‡ä»¶è¯»å†™.md](docs/æ–‡ä»¶è¯»å†™.md) | å•æ¬¡æ‰«ææ¶æ„ã€HeaderFooterAwareReader |
| [å…ƒæ•°æ®è¡¨.md](docs/å…ƒæ•°æ®è¡¨.md) | Spring Batch å…ƒæ•°æ®è¡¨ç»“æ„ä¸æ–­ç‚¹ç»­ä¼  |
| [æµ‹è¯•æ–‡æ¡£.md](docs/æµ‹è¯•æ–‡æ¡£.md) | æµ‹è¯•ç”¨ä¾‹ã€éªŒè¯æ–¹æ³•ã€æ€§èƒ½åŸºå‡† |

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒè¦æ±‚

- Java 21
- Maven 3.8+
- SQL Server 2022
- Spring Boot 3.5.7

### 2. æ•°æ®åº“é…ç½®

ä¿®æ”¹ `src/main/resources/application.yml`ï¼š

```yaml
spring:
  datasource:
    db1:
      jdbc-url: jdbc:sqlserver://localhost:1433;databaseName=BatchWeaverDB
      username: sa
      password: YourPassword123
```

### 3. åˆå§‹åŒ–æ•°æ®åº“

```sql
CREATE DATABASE BatchWeaverDB;
CREATE DATABASE DB2_Business;
```

### 4. è¿è¡Œé¡¹ç›®

```bash
mvn clean install
mvn spring-boot:run
```

ğŸ“– **è¯¦ç»†æ­¥éª¤**ï¼šå‚è§ [docs/å¿«é€Ÿå¼€å§‹.md](docs/å¿«é€Ÿå¼€å§‹.md)

---

## ğŸ›  æŠ€æœ¯æ ˆ

| ç»„ä»¶ | ç‰ˆæœ¬/æŠ€æœ¯ |
|------|-----------|
| æ¡†æ¶ | Spring Boot 3.5.7 + Spring Batch 5.x |
| æ•°æ®åº“ | SQL Server 2022 + HikariCP |
| è¯­è¨€ | Java 21 |
| æ„å»ºå·¥å…· | Maven 3.8+ |

---

## ğŸ“‹ æ ¸å¿ƒç±»è¯´æ˜

### å·¥å‚æ¨¡å¼ç»„ä»¶ â­

| ç±»å | èŒè´£ |
|------|------|
| **BatchReaderFactory** | ç»Ÿä¸€åˆ›å»ºå’Œåˆå§‹åŒ– JdbcPagingItemReader |
| **BatchWriterFactory** | åˆ›å»º FlatFileItemWriter å¹¶å¼ºåˆ¶ stream æ³¨å†Œ |

### å•æ¬¡æ‰«ææ¶æ„ç»„ä»¶

| ç±»å | èŒè´£ |
|------|------|
| **HeaderFooterAwareReader** | å»¶è¿Ÿå†³ç­– Reader - å•æ¬¡æ‰«æ + O(1) å†…å­˜ |
| **FooterLineDetector** | Footer è¡Œæ£€æµ‹å‡½æ•°å¼æ¥å£ |
| **FileImportJobTemplate** | æ–‡ä»¶å¯¼å…¥ Job æ„å»ºæ¨¡æ¿ |

### åŸºç¡€è®¾æ–½ç»„ä»¶

| ç±»å | èŒè´£ |
|------|------|
| **BatchInfrastructureConfig** | JobRepository ç»‘å®š tm1Meta |
| **DataSource1-4Config** | 4 ä¸ªæ•°æ®æºé…ç½® |

### æ–‡ä»¶å¤„ç†ç»„ä»¶

| ç±»å | èŒè´£ |
|------|------|
| **AnnotationDrivenFieldSetMapper** | @FileColumn æ³¨è§£è§£æ |
| **HeaderParser/FooterParser** | å¤´å°¾è¡Œè§£æ |
| **HeaderValidator/FooterValidator** | å¤´å°¾è¡Œæ ¡éªŒ |

### é…ç½®åˆ†å±‚ç»„ä»¶ â­

| ç±»å | èŒè´£ |
|------|------|
| **SharedWritersConfig** | å…±äº« Writer Beanï¼ˆdb2/db3/db4ï¼‰ |
| **SharedListenersConfig** | å…±äº« Listener Beanï¼ˆchunk/step/footerï¼‰ |
| **SharedProcessorsConfig** | å…±äº« Processor Beanï¼ˆæ•°æ®è½¬æ¢ï¼‰ |

---

## ğŸ“„ License

MIT License

---

**âš ï¸ é‡è¦æç¤º**ï¼š
1. å…ƒæ•°æ®äº‹åŠ¡ï¼ˆtm1Metaï¼‰ä¸ä¸šåŠ¡äº‹åŠ¡ï¼ˆtm1/tm2/tm3/tm4ï¼‰å¿…é¡»ä¸¥æ ¼éš”ç¦»
2. JobRepository å¿…é¡»ç»‘å®š tm1Meta
3. Step å¿…é¡»æ˜¾å¼æŒ‡å®šä¸šåŠ¡äº‹åŠ¡ç®¡ç†å™¨
4. Service å±‚ @Transactional æ³¨è§£å¿…é¡»æŒ‡å®š transactionManager

è¿åä»¥ä¸ŠåŸåˆ™å°†å¯¼è‡´äº‹åŠ¡éš”ç¦»å¤±æ•ˆï¼
